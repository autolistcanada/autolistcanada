<!DOCTYPE html>
<html lang="en" class="bg-white h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listings | AutoList Canada</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body {
      background: url('listings-background.png') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
    }
    /* Abstract wave overlay for brand */
    .wave-bg {
      background: linear-gradient(120deg, rgba(255,153,0,0.06) 0%, rgba(97,192,146,0.12) 100%);
      pointer-events: none;
      z-index: 0;
    }
    .sidebar {
      background: rgba(255,255,255,0.94);
      border-right: 1px solid #eee;
      min-width: 220px;
    }
    .sidebar-btn.active, .sidebar-btn:hover {
      background: #ff9800 !important;
      color: #fff !important;
    }
    .sidebar-btn.active svg, .sidebar-btn:hover svg {
      color: #fff;
    }
    .table-row-sel {
      background: rgba(97,192,146,0.06);
    }
    .bulk-bar {
      box-shadow: 0 2px 12px rgba(0,0,0,0.18);
    }
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 7px; background: #f5f5f5; }
    ::-webkit-scrollbar-thumb { background: #ff9800; border-radius: 4px; }
    /* Responsive tweaks */
    @media (max-width: 900px) {
      .sidebar { min-width: 60px; }
      .sidebar-btn span { display: none; }
      .sidebar-logo, .sidebar-title { margin: 0 auto; }
    }
  </style>
  <!-- Leaflet CDN -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body class="relative min-h-screen flex bg-white">
  <!-- Sidebar -->
  <aside class="sidebar fixed top-0 left-0 h-full flex flex-col z-30 shadow-md">
    <div class="p-4 flex flex-col items-center">
      <img src="autolist-logo.png" class="sidebar-logo w-12 h-12 mb-2" alt="AutoList Logo"/>
      <img src="autolist-title.png" class="sidebar-title w-28 mb-4" alt="AutoList Title"/>
    </div>
    <nav class="flex-1">
      <ul class="space-y-2 px-2">
        <li><a href="#" class="sidebar-btn flex items-center gap-3 px-3 py-2 rounded-lg text-orange-600 font-semibold active" data-nav="home"><svg class="w-5 h-5" fill="none" stroke="currentColor"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span data-i18n="Home">Home</span></a></li>
        <li><a href="#" class="sidebar-btn flex items-center gap-3 px-3 py-2 rounded-lg text-orange-600 font-semibold" data-nav="dashboard"><svg class="w-5 h-5" fill="none" stroke="currentColor"><path d="M12 8V4m0 0L8 8m4-4l4 4M4 12h16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span data-i18n="Dashboard">Dashboard</span></a></li>
        <li><a href="#" class="sidebar-btn flex items-center gap-3 px-3 py-2 rounded-lg text-orange-600 font-semibold active" data-nav="listings"><svg class="w-5 h-5" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span data-i18n="Listings">Listings</span></a></li>
        <li><a href="#" class="sidebar-btn flex items-center gap-3 px-3 py-2 rounded-lg text-orange-600 font-semibold" data-nav="ai-tools"><svg class="w-5 h-5" fill="none" stroke="currentColor"><path d="M11.05 2.05a7 7 0 019.9 9.9M9.172 16.172a4 4 0 005.656 0m-5.656 0L3 22m6.172-5.828l-8.486-8.486" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span data-i18n="AI Tools">AI Tools</span></a></li>
        <li><a href="#" class="sidebar-btn flex items-center gap-3 px-3 py-2 rounded-lg text-orange-600 font-semibold" data-nav="how-it-works"><svg class="w-5 h-5" fill="none" stroke="currentColor"><path d="M12 8v4l3 3m6 2A9 9 0 1112 3a9 9 0 019 9z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span data-i18n="How It Works">How It Works</span></a></li>
        <li><a href="#" class="sidebar-btn flex items-center gap-3 px-3 py-2 rounded-lg text-orange-600 font-semibold" data-nav="faq"><svg class="w-5 h-5" fill="none" stroke="currentColor"><path d="M8 10h.01M12 10h.01M16 10h.01M9 16h6m2 2a2 2 0 002-2V6a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2h10z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span data-i18n="FAQ">FAQ</span></a></li>
        <li><a href="#" class="sidebar-btn flex items-center gap-3 px-3 py-2 rounded-lg text-orange-600 font-semibold" data-nav="import"><svg class="w-5 h-5" fill="none" stroke="currentColor"><path d="M4 4v16h16V4H4zm4 8v4h4v-4h3l-5-5-5 5h3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span data-i18n="Import">Import</span></a></li>
        <li><a href="#" class="sidebar-btn flex items-center gap-3 px-3 py-2 rounded-lg text-orange-600 font-semibold" data-nav="terms"><svg class="w-5 h-5" fill="none" stroke="currentColor"><path d="M12 8c-3.314 0-6 2.239-6 5a6 6 0 0012 0c0-2.761-2.686-5-6-5z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span data-i18n="Terms">Terms</span></a></li>
        <li><a href="#" class="sidebar-btn flex items-center gap-3 px-3 py-2 rounded-lg text-orange-600 font-semibold" data-nav="privacy"><svg class="w-5 h-5" fill="none" stroke="currentColor"><path d="M12 22s8-4 8-10V5.236A2.238 2.238 0 0018.764 3H5.236A2.238 2.238 0 003 5.236V12c0 6 8 10 8 10z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span data-i18n="Privacy">Privacy</span></a></li>
      </ul>
    </nav>
    <div class="mt-auto p-4 flex items-center justify-between">
      <div class="w-full flex items-center justify-between">
        <span class="text-xs font-semibold text-gray-600">EN</span>
        <label class="relative inline-flex items-center cursor-pointer ml-1 mr-1">
          <input type="checkbox" id="langToggle" class="sr-only peer">
          <div class="w-10 h-5 bg-gray-200 rounded-full peer peer-checked:bg-green-500"></div>
          <span class="absolute left-3 text-xs top-0.5 text-white pointer-events-none select-none peer-checked:left-7 peer-checked:text-orange-50">FR</span>
        </label>
      </div>
    </div>
  </aside>
  <!-- Main Content -->
  <main class="flex-1 ml-[220px] min-h-screen relative">
    <div class="wave-bg absolute inset-0 pointer-events-none"></div>
    <!-- Platform Strip -->
    <section class="w-full px-6 pt-6 pb-3 z-10 relative">
      <div id="platform-strip" class="flex items-center gap-3 overflow-x-auto pb-2">
        <!-- JS Populates -->
      </div>
    </section>
    <!-- Top Bar -->
    <div class="flex flex-wrap items-center justify-between px-6 pb-2">
      <div>
        <h2 class="text-2xl font-bold text-orange-600 mb-1" data-i18n="Your Listings">Your Listings</h2>
        <span class="text-sm text-gray-500" id="listing-count"></span>
      </div>
      <div class="flex gap-2">
        <button id="table-view-btn" class="px-2 py-1 rounded bg-orange-100 text-orange-700 font-semibold transition hover:bg-orange-300 flex items-center" aria-label="Table"><span class="text-xl">📃</span></button>
        <button id="grid-view-btn" class="px-2 py-1 rounded bg-green-100 text-green-700 font-semibold transition hover:bg-green-300 flex items-center" aria-label="Grid"><span class="text-xl">🟦</span></button>
      </div>
    </div>
    <!-- Listings Table -->
    <div id="listings-section" class="px-6 pb-4">
      <div id="listings-table-view">
        <!-- JS Populates -->
      </div>
      <div id="listings-grid-view" class="hidden">
        <!-- JS Populates -->
      </div>
    </div>
    <!-- Map + Buyer Psychology -->
    <section class="px-6 pb-4">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="w-full md:w-1/2 bg-white rounded-lg shadow border overflow-hidden">
          <div class="p-2 font-semibold text-gray-700 flex items-center gap-2"><span class="text-green-600">🧠</span><span data-i18n="Buyer Psychology Map">Buyer Psychology Map</span></div>
          <div id="buyer-map" class="w-full h-72"></div>
          <div id="bubble-legend" class="flex flex-wrap gap-2 p-2 text-xs"></div>
        </div>
        <div class="w-full md:w-1/2 flex flex-col justify-center">
          <div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded shadow">
            <div class="font-semibold text-orange-700 mb-2" data-i18n="Tone Insights">Tone Insights:</div>
            <div id="tone-insights" class="text-gray-700 text-sm"></div>
          </div>
        </div>
      </div>
    </section>
    <!-- AI Suggest Modal -->
    <div id="ai-modal" class="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center hidden">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
        <button class="absolute top-2 right-2 text-gray-400 hover:text-orange-500 text-2xl" id="ai-modal-close">&times;</button>
        <h3 class="text-lg font-bold mb-2 flex items-center gap-2"><span class="text-orange-500">⚡</span><span data-i18n="AI Listing Enhancer">AI Listing Enhancer</span></h3>
        <form id="ai-modal-form" class="space-y-3">
          <div>
            <label class="block text-xs font-semibold text-gray-600" data-i18n="AI Title">AI Title</label>
            <input type="text" id="ai-title" class="w-full border rounded px-2 py-1 mt-1" readonly>
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-600" data-i18n="AI Tone">AI Tone</label>
            <select id="ai-tone" class="w-full border rounded px-2 py-1 mt-1"></select>
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-600" data-i18n="AI Price">AI Price</label>
            <input type="number" id="ai-price" class="w-full border rounded px-2 py-1 mt-1" readonly>
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-600" data-i18n="AI Description">AI Description</label>
            <textarea id="ai-desc" class="w-full border rounded px-2 py-1 mt-1" rows="2" readonly></textarea>
          </div>
          <button type="submit" class="w-full bg-orange-500 text-white py-2 rounded font-bold hover:bg-orange-600 transition" data-i18n="Apply AI Edits">Apply AI Edits</button>
        </form>
      </div>
    </div>
    <!-- Bulk Action Bar -->
    <div id="bulk-bar" class="bulk-bar fixed left-0 right-0 bottom-0 p-3 bg-white border-t border-orange-400 flex gap-4 justify-center items-center shadow-lg z-40 hidden">
      <button id="bulk-edit-price" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded font-semibold" data-i18n="Bulk Edit Price">Bulk Edit Price</button>
      <button id="bulk-mark-sold" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-semibold" data-i18n="Mark as Sold">Mark as Sold</button>
      <button id="bulk-sync" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-semibold" data-i18n="Sync to All Platforms">Sync to All Platforms</button>
    </div>
  </main>
  <!-- Mobile Sidebar Overlay -->
  <div id="sidebar-overlay" class="hidden fixed inset-0 z-20 bg-black bg-opacity-30"></div>
  <!-- JS DATA + LOGIC -->
  <script>
    // EN/FR dictionary
    const DICT = {
      "Home": {"fr": "Accueil"},
      "Dashboard": {"fr": "Tableau de bord"},
      "Listings": {"fr": "Annonces"},
      "AI Tools": {"fr": "Outils IA"},
      "How It Works": {"fr": "Comment ça marche"},
      "FAQ": {"fr": "FAQ"},
      "Import": {"fr": "Importer"},
      "Terms": {"fr": "Conditions"},
      "Privacy": {"fr": "Confidentialité"},
      "Your Listings": {"fr": "Vos annonces"},
      "Buyer Psychology Map": {"fr": "Carte Psychologique Acheteur"},
      "Tone Insights:": {"fr": "Aperçu des tons :"},
      "AI Listing Enhancer": {"fr": "Améliorateur d'annonce IA"},
      "AI Title": {"fr": "Titre IA"},
      "AI Tone": {"fr": "Ton IA"},
      "AI Price": {"fr": "Prix IA"},
      "AI Description": {"fr": "Description IA"},
      "Apply AI Edits": {"fr": "Appliquer les modifications IA"},
      "Bulk Edit Price": {"fr": "Modifier le prix en lot"},
      "Mark as Sold": {"fr": "Marquer comme vendu"},
      "Sync to All Platforms": {"fr": "Synchroniser toutes plateformes"},
      "Connected": {"fr": "Connecté"},
      "Connect": {"fr": "Connecter"}
    };
    // Platform metadata
    const PLATFORMS = [
      {key: 'ebay', label: 'eBay', icon: '🛒', color: 'bg-blue-700', avatar: 'https://upload.wikimedia.org/wikipedia/commons/5/5e/Ebay_logo.png'},
      {key: 'poshmark', label: 'Poshmark', icon: '👠', color: 'bg-pink-700', avatar: 'https://cdn.iconscout.com/icon/free/png-256/poshmark-3521442-2944917.png'},
      {key: 'facebook', label: 'Facebook', icon: '📘', color: 'bg-blue-600', avatar: 'https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg'},
      {key: 'etsy', label: 'Etsy', icon: '🧶', color: 'bg-orange-500', avatar: 'https://upload.wikimedia.org/wikipedia/commons/4/4b/Etsy_logo.png'},
      {key: 'shopify', label: 'Shopify', icon: '🛍️', color: 'bg-green-700', avatar: 'https://cdn.iconscout.com/icon/free/png-256/shopify-226579.png'},
      {key: 'mercari', label: 'Mercari', icon: '📦', color: 'bg-red-400', avatar: 'https://cdn.iconscout.com/icon/free/png-256/mercari-3251596-2711536.png'},
      {key: 'instagram', label: 'Instagram', icon: '📷', color: 'bg-gradient-to-tr from-pink-500 to-yellow-400', avatar: 'https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png'},
      {key: 'tiktok', label: 'TikTok', icon: '🎵', color: 'bg-black', avatar: 'https://upload.wikimedia.org/wikipedia/commons/0/08/TikTok_logo.svg'},
      {key: 'depop', label: 'Depop', icon: '🧢', color: 'bg-red-600', avatar: 'https://upload.wikimedia.org/wikipedia/commons/3/3e/Depop_app_logo.png'},
    ];
    // Tone metadata
    const TONES = [
      {key: 'cozy', label: {en:"Cozy",fr:"Chaleureux"}, color: 'bg-orange-200 text-orange-700'},
      {key: 'minimalist', label: {en:"Minimalist",fr:"Minimaliste"}, color: 'bg-green-200 text-green-700'},
      {key: 'budget', label: {en:"Budget",fr:"Économique"}, color: 'bg-blue-100 text-blue-700'},
      {key: 'luxury', label: {en:"Luxury",fr:"Luxe"}, color: 'bg-yellow-100 text-yellow-700'},
      {key: 'warm', label: {en:"Warm",fr:"Chaud"}, color: 'bg-red-100 text-red-700'}
    ];
    // Listings Demo Data (simulate real data)
    let LISTINGS = [
      {
        id: 1,
        image: 'https://images.unsplash.com/photo-1503736334956-4c8f8e92946d?w=200&q=80',
        title: "Handmade Wool Scarf",
        sku: "SCF-001",
        price: 42.99,
        platforms: {ebay: true, poshmark: true, facebook: false, etsy: true, shopify: false, mercari: false, instagram: true, tiktok: false, depop: false},
        tone: "cozy",
        sold: false,
        editable: true,
        description: "A cozy, warm, hand-knitted scarf for winter."
      },
      {
        id: 2,
        image: 'https://images.unsplash.com/photo-1526170375885-4d8ecf77b99f?w=200&q=80',
        title: "Minimalist Ceramic Vase",
        sku: "VAS-014",
        price: 29.99,
        platforms: {ebay: false, poshmark: false, facebook: true, etsy: true, shopify: true, mercari: false, instagram: false, tiktok: false, depop: false},
        tone: "minimalist",
        sold: false,
        editable: true,
        description: "Elegant minimalist vase, perfect for modern decor."
      },
      {
        id: 3,
        image: 'https://images.unsplash.com/photo-1519125323398-675f0ddb6308?w=200&q=80',
        title: "Budget Family Toque",
        sku: "TOQ-003",
        price: 12.00,
        platforms: {ebay: true, poshmark: false, facebook: false, etsy: false, shopify: false, mercari: true, instagram: false, tiktok: false, depop: true},
        tone: "budget",
        sold: false,
        editable: true,
        description: "Affordable toque, keeps the whole family warm!"
      },
      {
        id: 4,
        image: 'https://images.unsplash.com/photo-1465101046530-73398c7f28ca?w=200&q=80',
        title: "Luxury Cashmere Gloves",
        sku: "GLV-009",
        price: 120.00,
        platforms: {ebay: true, poshmark: true, facebook: true, etsy: false, shopify: false, mercari: false, instagram: true, tiktok: true, depop: false},
        tone: "luxury",
        sold: false,
        editable: true,
        description: "High-end cashmere gloves for a luxurious winter."
      },
      {
        id: 5,
        image: 'https://images.unsplash.com/photo-1519985176271-adb1088fa94c?w=200&q=80',
        title: "Warm Quebec Blanket",
        sku: "BLK-QC",
        price: 65.50,
        platforms: {ebay: false, poshmark: true, facebook: false, etsy: true, shopify: false, mercari: false, instagram: false, tiktok: false, depop: false},
        tone: "warm",
        sold: false,
        editable: true,
        description: "Traditional Quebec blanket, soft and warm."
      }
    ];
    // Platform connections simulation
    let PLATFORM_CONNECTIONS = {
      ebay: true, poshmark: true, facebook: false, etsy: true, shopify: false, mercari: false, instagram: true, tiktok: false, depop: false
    };

    // Language state
    let LANG = localStorage.getItem('autolist-lang') || 'en';

    // Selected listing IDs for bulk actions
    let selectedRows = [];

    // Table/grid mode
    let IS_GRID = false;

    // --- UI RENDERING ---

    function i18n(text) {
      if (LANG === 'fr' && DICT[text]) return DICT[text].fr;
      return text;
    }

    function updateLangUI() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const orig = el.getAttribute('data-i18n');
        el.textContent = i18n(orig);
      });
    }

    function renderPlatformStrip() {
      const strip = document.getElementById('platform-strip');
      strip.innerHTML = '';
      PLATFORMS.forEach(p => {
        const connected = PLATFORM_CONNECTIONS[p.key];
        const badge = connected
          ? `<span class="flex items-center gap-1 px-2 py-0.5 bg-green-100 text-green-700 font-semibold rounded text-xs ml-2"><span>${i18n("Connected")}</span><img src="${p.avatar}" alt="${p.label}" class="w-4 h-4 rounded-full border ml-1"></span>`
          : `<button class="px-2 py-0.5 bg-orange-500 text-white rounded text-xs font-semibold hover:bg-orange-600 transition ml-2" data-connect="${p.key}">${i18n("Connect")}</button>`;
        strip.innerHTML += `
        <div class="flex items-center gap-2 px-3 py-2 rounded shadow-sm bg-white border mr-2 min-w-[120px]">
          <span class="text-2xl">${p.icon}</span>
          <span class="font-semibold">${p.label}</span>
          ${badge}
        </div>`;
      });
      // Connect logic
      strip.querySelectorAll('[data-connect]').forEach(btn => {
        btn.onclick = e => {
          const key = btn.getAttribute('data-connect');
          PLATFORM_CONNECTIONS[key] = true;
          renderPlatformStrip();
        }
      });
    }

    function renderListingsTable() {
      const tableDiv = document.getElementById('listings-table-view');
      let html = `<div class="overflow-x-auto">
      <table class="min-w-full border rounded-lg bg-white shadow">
        <thead>
          <tr class="bg-orange-100 text-orange-800 text-xs">
            <th class="p-2"><input type="checkbox" id="sel-all"></th>
            <th class="p-2">${i18n("Image")}</th>
            <th class="p-2">${i18n("Title")}</th>
            <th class="p-2">${i18n("SKU")}</th>
            <th class="p-2">${i18n("Price")}</th>
            <th class="p-2">${i18n("Tone")}</th>
            <th class="p-2">${i18n("Platforms")}</th>
            <th class="p-2">${i18n("Actions")}</th>
          </tr>
        </thead>
        <tbody>`;
      LISTINGS.forEach(row => {
        const isSelected = selectedRows.includes(row.id);
        html += `<tr class="${isSelected ? 'table-row-sel' : ''} text-sm border-b hover:bg-orange-50 transition">
          <td class="p-2">
            <input type="checkbox" class="sel-row" value="${row.id}" ${isSelected ? "checked" : ""}>
          </td>
          <td class="p-2">
            <img src="${row.image || 'https://placehold.co/60x60?text=No+Img'}" alt="" class="w-12 h-12 rounded shadow border bg-gray-100 object-cover">
          </td>
          <td class="p-2 font-semibold max-w-[200px]">
            <span class="editable-title cursor-pointer" data-id="${row.id}">${row.title}</span>
          </td>
          <td class="p-2">${row.sku}</td>
          <td class="p-2">
            <input type="number" class="editable-price border rounded px-2 py-0.5 w-20" value="${row.price}" data-id="${row.id}"${row.editable ? '' : 'readonly'}>
          </td>
          <td class="p-2">
            <select class="editable-tone border rounded px-1 py-0.5" data-id="${row.id}"${row.editable ? '' : 'disabled'}>
              ${TONES.map(t => `<option value="${t.key}"${t.key===row.tone?' selected':''}>${t.label[LANG]}</option>`).join('')}
            </select>
          </td>
          <td class="p-2">
            <div class="flex gap-1 flex-wrap">
              ${PLATFORMS.map(p => `
                <label class="flex items-center gap-1 cursor-pointer">
                  <input type="checkbox" data-platform="${p.key}" data-id="${row.id}" class="platform-toggle" ${row.platforms[p.key]?'checked':''}>
                  <span title="${p.label}" class="text-lg">${p.icon}</span>
                </label>
              `).join('')}
            </div>
          </td>
          <td class="p-2">
            <button class="edit-btn text-gray-500 hover:text-orange-500 mr-1" data-id="${row.id}" title="${i18n('Edit')}">✏️</button>
            <button class="del-btn text-gray-500 hover:text-red-500 mr-1" data-id="${row.id}" title="${i18n('Delete')}">🗑️</button>
            <button class="ai-btn text-gray-500 hover:text-green-500 mr-1" data-id="${row.id}" title="${i18n('AI Listing Enhancer')}">⚡</button>
            <button class="comment-btn text-gray-500 hover:text-blue-500" data-id="${row.id}" title="${i18n('Comment')}">💬</button>
          </td>
        </tr>`;
      });
      html += `</tbody></table></div>`;
      tableDiv.innerHTML = html;

      // Listeners
      document.querySelectorAll('.sel-row').forEach(cb => {
        cb.onchange = () => {
          const id = Number(cb.value);
          if (cb.checked) {
            if (!selectedRows.includes(id)) selectedRows.push(id);
          } else {
            selectedRows = selectedRows.filter(x => x !== id);
          }
          renderBulkBar();
          renderListingsTable();
        }
      });
      document.getElementById('sel-all').onchange = (e) => {
        if (e.target.checked) {
          selectedRows = LISTINGS.map(l => l.id);
        } else {
          selectedRows = [];
        }
        renderBulkBar();
        renderListingsTable();
      }
      document.querySelectorAll('.editable-title').forEach(span => {
        span.onclick = () => {
          const id = Number(span.dataset.id);
          const row = LISTINGS.find(l => l.id === id);
          if (!row.editable) return;
          const td = span.parentElement;
          td.innerHTML = `<input type="text" class="edit-title-input border px-2 py-1 rounded w-full" value="${row.title}" data-id="${id}">`;
          td.querySelector('input').focus();
          td.querySelector('input').onblur = (e) => {
            row.title = e.target.value;
            renderListingsTable();
            renderListingsGrid();
          }
          td.querySelector('input').onkeydown = (e) => {
            if (e.key === "Enter") {
              row.title = e.target.value;
              renderListingsTable();
              renderListingsGrid();
            }
          }
        }
      });
      document.querySelectorAll('.editable-price').forEach(inp => {
        inp.onchange = () => {
          const id = Number(inp.dataset.id);
          const row = LISTINGS.find(l => l.id === id);
          row.price = parseFloat(inp.value);
          renderListingsTable();
          renderListingsGrid();
        }
      });
      document.querySelectorAll('.editable-tone').forEach(sel => {
        sel.onchange = () => {
          const id = Number(sel.dataset.id);
          const row = LISTINGS.find(l => l.id === id);
          row.tone = sel.value;
          renderListingsTable();
          renderListingsGrid();
          renderBuyerMap();
        }
      });
      document.querySelectorAll('.platform-toggle').forEach(cb => {
        cb.onchange = () => {
          const id = Number(cb.dataset.id);
          const pf = cb.dataset.platform;
          const row = LISTINGS.find(l => l.id === id);
          row.platforms[pf] = cb.checked;
          renderListingsTable();
          renderListingsGrid();
        }
      });
      document.querySelectorAll('.ai-btn').forEach(btn => {
        btn.onclick = () => openAIModal(btn.dataset.id);
      });
      document.querySelectorAll('.del-btn').forEach(btn => {
        btn.onclick = () => {
          if (confirm(i18n("Delete") + "?")) {
            LISTINGS = LISTINGS.filter(l => l.id !== Number(btn.dataset.id));
            selectedRows = selectedRows.filter(x => x !== Number(btn.dataset.id));
            renderListingsTable();
            renderListingsGrid();
            renderBulkBar();
            renderBuyerMap();
            renderToneInsights();
            updateListingCount();
          }
        }
      });
      document.querySelectorAll('.edit-btn').forEach(btn => {
        // Focus title input
        btn.onclick = () => {
          const id = Number(btn.dataset.id);
          const span = document.querySelector(`.editable-title[data-id="${id}"]`);
          if (span) span.click();
        }
      });
      updateListingCount();
    }

    function renderListingsGrid() {
      const gridDiv = document.getElementById('listings-grid-view');
      let html = `<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">`;
      LISTINGS.forEach(row => {
        html += `<div class="bg-white rounded-lg shadow border p-3 flex flex-col gap-2 opacity-0 animate-fadein" style="animation:fadeIn 0.4s ease forwards;">
          <div class="flex gap-2">
            <input type="checkbox" class="sel-row" value="${row.id}" ${selectedRows.includes(row.id) ? "checked" : ""}>
            <img src="${row.image || 'https://placehold.co/80x80?text=No+Img'}" alt="" class="w-20 h-20 rounded bg-gray-100 object-cover border">
          </div>
          <div class="font-bold text-lg">${row.title}</div>
          <div class="text-xs text-gray-500">${row.sku}</div>
          <div class="flex items-center gap-1">
            <span class="font-semibold text-orange-700">$${row.price.toFixed(2)}</span>
            <span class="ml-auto px-2 py-0.5 rounded text-xs font-semibold ${TONES.find(t=>t.key===row.tone).color}">
              ${TONES.find(t=>t.key===row.tone).label[LANG]}
            </span>
          </div>
          <div class="flex gap-1 flex-wrap">
            ${PLATFORMS.map(p => `
                <label class="flex items-center gap-1 cursor-pointer">
                  <input type="checkbox" data-platform="${p.key}" data-id="${row.id}" class="platform-toggle" ${row.platforms[p.key]?'checked':''}>
                  <span title="${p.label}" class="text-lg">${p.icon}</span>
                </label>
            `).join('')}
          </div>
          <div class="flex gap-2 mt-2">
            <button class="ai-btn flex-1 bg-green-100 hover:bg-green-200 text-green-700 px-1 py-1 rounded" data-id="${row.id}" title="${i18n('AI Listing Enhancer')}">⚡ ${i18n("AI")}</button>
            <button class="del-btn flex-1 bg-red-100 hover:bg-red-200 text-red-700 px-1 py-1 rounded" data-id="${row.id}" title="${i18n('Delete')}">🗑️ ${i18n("Del")}</button>
          </div>
        </div>`;
      });
      html += `</div>
      <style>
      @keyframes fadeIn {
        from { opacity:0; transform:translateY(24px);}
        to { opacity:1; transform:translateY(0);}
      }
      .animate-fadein { animation:fadeIn 0.5s ease;}
      </style>`;
      gridDiv.innerHTML = html;
      document.querySelectorAll('.sel-row').forEach(cb => {
        cb.onchange = () => {
          const id = Number(cb.value);
          if (cb.checked) {
            if (!selectedRows.includes(id)) selectedRows.push(id);
          } else {
            selectedRows = selectedRows.filter(x => x !== id);
          }
          renderBulkBar();
          renderListingsTable();
          renderListingsGrid();
        }
      });
      document.querySelectorAll('.platform-toggle').forEach(cb => {
        cb.onchange = () => {
          const id = Number(cb.dataset.id);
          const pf = cb.dataset.platform;
          const row = LISTINGS.find(l => l.id === id);
          row.platforms[pf] = cb.checked;
          renderListingsTable();
          renderListingsGrid();
        }
      });
      document.querySelectorAll('.ai-btn').forEach(btn => {
        btn.onclick = () => openAIModal(btn.dataset.id);
      });
      document.querySelectorAll('.del-btn').forEach(btn => {
        btn.onclick = () => {
          if (confirm(i18n("Delete") + "?")) {
            LISTINGS = LISTINGS.filter(l => l.id !== Number(btn.dataset.id));
            selectedRows = selectedRows.filter(x => x !== Number(btn.dataset.id));
            renderListingsTable();
            renderListingsGrid();
            renderBulkBar();
            renderBuyerMap();
            renderToneInsights();
            updateListingCount();
          }
        }
      });
      updateListingCount();
    }

    function updateListingCount() {
      document.getElementById('listing-count').textContent = `${LISTINGS.length} ${i18n('Listings')}`;
    }

    function renderBulkBar() {
      const bar = document.getElementById('bulk-bar');
      if (selectedRows.length >= 2) {
        bar.classList.remove('hidden');
      } else {
        bar.classList.add('hidden');
      }
    }

    // --- AI SUGGEST MODAL LOGIC ---
    function openAIModal(id) {
      const row = LISTINGS.find(l => l.id === Number(id));
      if (!row) return;
      document.getElementById('ai-title').value = aiSuggestTitle(row.title, row.tone);
      document.getElementById('ai-tone').innerHTML = TONES.map(t => `<option value="${t.key}"${t.key===row.tone?' selected':''}>${t.label[LANG]}</option>`).join('');
      document.getElementById('ai-price').value = aiSuggestPrice(row.price, row.tone);
      document.getElementById('ai-desc').value = aiSuggestDesc(row.title, row.tone, row.price, row.description);
      document.getElementById('ai-modal').classList.remove('hidden');
      document.getElementById('ai-modal-form').onsubmit = (e) => {
        e.preventDefault();
        row.title = document.getElementById('ai-title').value;
        row.tone = document.getElementById('ai-tone').value;
        row.price = parseFloat(document.getElementById('ai-price').value);
        row.description = document.getElementById('ai-desc').value;
        document.getElementById('ai-modal').classList.add('hidden');
        renderListingsTable();
        renderListingsGrid();
        renderBuyerMap();
        renderToneInsights();
      }
    }
    document.getElementById('ai-modal-close').onclick = () => {
      document.getElementById('ai-modal').classList.add('hidden');
    }

    // Simulate AI suggestion with simple logic (no GPT)
    function aiSuggestTitle(title, tone) {
      // Just add a tone-based phrase
      switch (tone) {
        case 'luxury': return "Premium: " + title;
        case 'cozy': return "Super Cozy " + title;
        case 'minimalist': return "Minimalist " + title;
        case 'budget': return "Great Deal: " + title;
        case 'warm': return "Warm & Welcoming " + title;
        default: return title;
      }
    }
    function aiSuggestPrice(price, tone) {
      // Simulate tone-based price adjustment
      switch (tone) {
        case 'luxury': return (price * 1.3).toFixed(2);
        case 'budget': return (price * 0.8).toFixed(2);
        case 'cozy': return (price * 1.05).toFixed(2);
        case 'minimalist': return (price * 1.0).toFixed(2);
        case 'warm': return (price * 1.1).toFixed(2);
        default: return price;
      }
    }
    function aiSuggestDesc(title, tone, price, desc) {
      // Simulate a richer description
      switch (tone) {
        case 'luxury': return `Indulge in luxury with this premium item: ${title}. Priced for the discerning buyer.`;
        case 'cozy': return `Snuggle up! ${title} offers warmth and comfort for any occasion.`;
        case 'minimalist': return `Sleek and simple: ${title}. A perfect fit for a modern lifestyle.`;
        case 'budget': return `Amazing value! ${title} – get it for only $${price}!`;
        case 'warm': return `Welcome home to warmth with this inviting ${title}.`;
        default: return desc;
      }
    }

    // --- BULK BAR LOGIC ---
    document.getElementById('bulk-edit-price').onclick = () => {
      const newPrice = prompt(i18n("Bulk Edit Price") + " ($):");
      if (newPrice && !isNaN(newPrice)) {
        LISTINGS.forEach(l => { if (selectedRows.includes(l.id)) l.price = Number(newPrice); });
        renderListingsTable();
        renderListingsGrid();
      }
    };
    document.getElementById('bulk-mark-sold').onclick = () => {
      LISTINGS.forEach(l => { if (selectedRows.includes(l.id)) l.sold = true; });
      renderListingsTable();
      renderListingsGrid();
    };
    document.getElementById('bulk-sync').onclick = () => {
      LISTINGS.forEach(l => {
        if (selectedRows.includes(l.id)) {
          PLATFORMS.forEach(p => l.platforms[p.key] = true);
        }
      });
      renderListingsTable();
      renderListingsGrid();
    };

    // --- GRID/TABLE TOGGLE ---
    document.getElementById('table-view-btn').onclick = () => {
      IS_GRID = false;
      document.getElementById('listings-table-view').classList.remove('hidden');
      document.getElementById('listings-grid-view').classList.add('hidden');
    };
    document.getElementById('grid-view-btn').onclick = () => {
      IS_GRID = true;
      document.getElementById('listings-grid-view').classList.remove('hidden');
      document.getElementById('listings-table-view').classList.add('hidden');
      renderListingsGrid();
    };

    // --- BUYER PSYCHOLOGY MAP ---
    let map, toneBubbles = [];
    function renderBuyerMap() {
      if (!map) {
        map = L.map('buyer-map', {scrollWheelZoom: false, zoomControl: false}).setView([56.1304, -106.3468], 4.2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: ''
        }).addTo(map);
      }
      toneBubbles.forEach(b => b.remove && b.remove());
      toneBubbles = [];
      // Map tone to region
      const regions = {
        'cozy': {center: [53, -105], label: 'Prairies'},
        'minimalist': {center: [54.5, -125], label: 'BC'},
        'budget': {center: [46.5, -63], label: 'Maritimes'},
        'luxury': {center: [43.7, -79.4], label: 'Toronto'},
        'warm': {center: [46.8, -71.2], label: 'Quebec'}
      };
      // Count listings per tone
      const counts = {};
      LISTINGS.forEach(l => { counts[l.tone] = (counts[l.tone]||0) + 1; });
      TONES.forEach(t => {
        const count = counts[t.key]||0;
        if (!regions[t.key]) return;
        const size = 35 + count*15;
        const bubble = L.circle(regions[t.key].center, {
          color: t.color.split(' ')[1],
          fillColor: t.color.split(' ')[1],
          fillOpacity: 0.35,
          radius: size*800
        }).addTo(map);
        bubble.bindTooltip(`${t.label[LANG]} (${regions[t.key].label}): ${count}`, {permanent:false, direction:'top'});
        bubble.on('click', () => {
          // Filter table to that tone
          LISTINGS = LISTINGS.filter(l => l.tone === t.key);
          selectedRows = [];
          renderListingsTable();
          renderListingsGrid();
          renderBulkBar();
          renderBuyerMap();
          renderToneInsights();
          updateListingCount();
        });
        toneBubbles.push(bubble);
      });
      // Legend
      const legend = document.getElementById('bubble-legend');
      legend.innerHTML = TONES.map(t=>`<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded ${t.color}"><span class="w-3 h-3 rounded-full inline-block" style="background:${t.color.split(' ')[1]}"></span> ${t.label[LANG]}</span>`).join('');
    }

    // --- TONE INSIGHTS ---
    function renderToneInsights() {
      const counts = {};
      LISTINGS.forEach(l => { counts[l.tone] = (counts[l.tone]||0) + 1; });
      let html = TONES.map(t => `<span class="font-bold text-sm mr-2">${t.label[LANG]}:</span> <span class="mr-4">${counts[t.key]||0}</span>`).join('');
      document.getElementById('tone-insights').innerHTML = html;
    }

    // --- LANGUAGE TOGGLE ---
    document.getElementById('langToggle').checked = (LANG === 'fr');
    document.getElementById('langToggle').onchange = (e) => {
      LANG = e.target.checked ? 'fr' : 'en';
      localStorage.setItem('autolist-lang', LANG);
      updateLangUI();
      renderPlatformStrip();
      renderListingsTable();
      renderListingsGrid();
      renderBuyerMap();
      renderToneInsights();
    };

    // --- INIT ---
    function init() {
      updateLangUI();
      renderPlatformStrip();
      renderListingsTable();
      renderListingsGrid();
      renderBuyerMap();
      renderToneInsights();
      renderBulkBar();
    }
    window.onload = init;
  </script>
</body>
</html>

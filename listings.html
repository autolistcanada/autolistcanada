<!DOCTYPE html>
<html lang="en" class="bg-[#F6F3EF]">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Listings – AutoList Canada</title>
  <link rel="icon" type="image/png" href="/assets/favicon.png">
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet.js CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <style>
    /* Frosted Glass */
    .frosted {
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(10px);
    }
    /* Sidebar organic curve (SVG background) */
    .sidebar-bg {
      background: url('/assets/sidebar-background.png') center/cover no-repeat;
    }
    /* Soft wave divider */
    .wave-divider {
      display: block;
      width: 100%;
      height: 40px;
      background: none;
      margin: 0;
    }
    /* Hide scrollbar */
    ::-webkit-scrollbar { width: 0 !important }
    .scrollbar-hide { scrollbar-width: none; -ms-overflow-style: none; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    /* Card Animations */
    .card-animate { animation: fadeInScale 0.5s ease; }
    @keyframes fadeInScale {
      0% { opacity: 0; transform: scale(0.95);}
      100% { opacity: 1; transform: scale(1);}
    }
  </style>
</head>
<body class="flex min-h-screen bg-[#F6F3EF] text-[#2B2320] font-sans">

<!-- Sidebar -->
<aside class="sidebar-bg w-64 flex flex-col text-white min-h-screen relative z-10">
  <div class="flex flex-col items-center py-8">
    <img src="/assets/logo.png" alt="AutoList Canada Logo" class="w-16 h-16 mb-2 rounded-full shadow-lg">
    <img src="/assets/autolist-title.png" alt="AutoList Canada" class="w-40 mb-6">
  </div>
  <nav class="flex-1 px-6 space-y-2">
    <a href="/home" class="block py-2 px-4 rounded-lg hover:bg-white/10 transition">Home</a>
    <a href="/dashboard" class="block py-2 px-4 rounded-lg hover:bg-white/10 transition">Dashboard</a>
    <a href="/listings" class="block py-2 px-4 rounded-lg bg-gradient-to-r from-[#F2C88A] to-[#E0985D] text-[#2B2320] font-bold shadow-inner">Listings</a>
    <a href="/ai-tools" class="block py-2 px-4 rounded-lg hover:bg-white/10 transition">AI Tools</a>
    <a href="/how-it-works" class="block py-2 px-4 rounded-lg hover:bg-white/10 transition">How It Works</a>
    <a href="/faq" class="block py-2 px-4 rounded-lg hover:bg-white/10 transition">FAQ</a>
    <a href="/import" class="block py-2 px-4 rounded-lg hover:bg-white/10 transition">Import</a>
    <a href="/terms" class="block py-2 px-4 rounded-lg hover:bg-white/10 transition">Terms</a>
    <a href="/privacy" class="block py-2 px-4 rounded-lg hover:bg-white/10 transition">Privacy</a>
  </nav>
  <div class="absolute bottom-0 w-full pb-6 px-6">
    <div class="flex items-center justify-between">
      <span class="text-xs text-white/70">CA EN</span>
      <button id="lang-toggle" class="text-xs bg-white/20 py-1 px-3 rounded-full font-semibold hover:bg-white/40 transition">FR</button>
    </div>
  </div>
</aside>

<!-- Main Content -->
<main class="flex-1 flex flex-col bg-[#F6F3EF]">
  <!-- Listings Header -->
  <section class="relative px-8 pt-10 pb-6 bg-[#F6F3EF] z-0">
    <div class="flex flex-wrap items-center gap-4">
      <!-- Search Bar -->
      <div class="flex items-center bg-white rounded-lg shadow px-3 py-2 w-full max-w-xs mr-4">
        <svg class="w-5 h-5 text-[#E0985D]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8" stroke-width="2"/><line x1="21" y1="21" x2="16.65" y2="16.65" stroke-width="2"/></svg>
        <input id="search" type="text" placeholder="Search title…" class="ml-2 outline-none bg-transparent w-full text-[#2B2320]"/>
      </div>
      <!-- Platform Filter -->
      <select id="platform-filter" class="bg-white rounded-lg px-3 py-2 shadow text-[#2B2320]">
        <option value="">All Platforms</option>
        <option value="eBay">eBay</option>
        <option value="Poshmark">Poshmark</option>
        <option value="Facebook">Facebook</option>
      </select>
      <!-- Buyer Intent Filter -->
      <select id="tone-filter" class="bg-white rounded-lg px-3 py-2 shadow text-[#2B2320]">
        <option value="">All Buyer Intents</option>
        <option value="Cozy">Cozy</option>
        <option value="Luxury">Luxury</option>
        <option value="Eco">Eco</option>
        <option value="Minimalist">Minimalist</option>
        <option value="Sporty">Sporty</option>
        <option value="Budget">Budget</option>
      </select>
      <!-- Hide Sold Toggle -->
      <label class="flex items-center cursor-pointer ml-4">
        <input id="hide-sold" type="checkbox" class="hidden peer">
        <span class="peer-checked:bg-[#E0985D] bg-gray-300 w-10 h-5 rounded-full flex items-center transition shadow-inner">
          <span class="peer-checked:translate-x-5 translate-x-1 inline-block w-4 h-4 bg-white rounded-full shadow transition"></span>
        </span>
        <span class="ml-2 text-sm font-medium">Hide Sold</span>
      </label>
      <!-- Grid/List Toggle -->
      <div class="flex items-center ml-4">
        <button id="list-view-btn" class="px-2 py-1 rounded-l-lg bg-[#E0985D] text-white font-semibold shadow focus:outline-none"><svg class="inline w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="4" y="6" width="16" height="4" rx="2"/><rect x="4" y="14" width="16" height="4" rx="2"/></svg></button>
        <button id="grid-view-btn" class="px-2 py-1 rounded-r-lg bg-white text-[#E0985D] font-semibold shadow focus:outline-none"><svg class="inline w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="4" y="4" width="7" height="7" rx="2"/><rect x="13" y="4" width="7" height="7" rx="2"/><rect x="4" y="13" width="7" height="7" rx="2"/><rect x="13" y="13" width="7" height="7" rx="2"/></svg></button>
      </div>
      <!-- Connected Platforms -->
      <div class="flex items-center ml-auto gap-3">
        <button id="ebay-btn" class="flex items-center gap-1 px-3 py-2 rounded-lg bg-gradient-to-r from-[#0071CE] to-[#86C3E6] text-white font-semibold shadow hover:shadow-lg transition" onclick="connectMarketplace('eBay')">
          <img src="/assets/ebay-logo.png" alt="eBay" class="w-5 h-5"> <span id="ebay-status">Connect eBay</span>
        </button>
        <button id="poshmark-btn" class="flex items-center gap-1 px-3 py-2 rounded-lg bg-gradient-to-r from-[#B8006B] to-[#F7ADC6] text-white font-semibold shadow hover:shadow-lg transition" onclick="connectMarketplace('Poshmark')">
          <img src="/assets/poshmark-logo.png" alt="Poshmark" class="w-5 h-5"> <span id="poshmark-status">Connect Poshmark</span>
        </button>
        <button id="facebook-btn" class="flex items-center gap-1 px-3 py-2 rounded-lg bg-gradient-to-r from-[#1877F2] to-[#68A5F2] text-white font-semibold shadow hover:shadow-lg transition" onclick="connectMarketplace('Facebook')">
          <img src="/assets/facebook-logo.png" alt="Facebook" class="w-5 h-5"> <span id="facebook-status">Connect Facebook</span>
        </button>
      </div>
    </div>
  </section>

  <!-- Wave Divider -->
  <svg class="wave-divider" viewBox="0 0 1440 40" fill="none" preserveAspectRatio="none"><path d="M0,20 C360,60 1080,0 1440,20 L1440,40 L0,40 Z" fill="#F6F3EF"/></svg>
  
  <!-- Bulk Sync Engine -->
  <section id="bulk-sync-section" class="px-8 py-4">
    <div id="connect-prompt" class="hidden bg-[#FFF5E5] border border-[#E0985D] text-[#2B2320] rounded-lg p-6 flex items-center justify-between shadow">
      <span class="text-lg font-semibold">Connect to eBay to import your listings.</span>
      <button class="bg-gradient-to-r from-[#F2C88A] to-[#E0985D] text-[#2B2320] font-bold py-2 px-6 rounded-lg shadow hover:shadow-lg transition" onclick="connectMarketplace('eBay')">
        <img src="/assets/ebay-logo.png" class="inline w-6 h-6 mr-2" alt="eBay"> Connect eBay
      </button>
    </div>
    <div id="sync-loading" class="hidden flex items-center gap-2">
      <svg class="animate-spin w-6 h-6 text-[#E0985D]" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
      <span class="font-medium">Syncing your eBay listings…</span>
    </div>
  </section>

  <!-- Listings Table (List View) -->
  <section id="listings-list-section" class="px-8 pb-8">
    <div class="overflow-x-auto rounded-lg shadow bg-white">
      <table id="listings-table" class="min-w-full text-left">
        <thead class="bg-gradient-to-r from-[#F2C88A] to-[#E0985D] text-[#2B2320]">
          <tr>
            <th class="py-3 px-4">Image</th>
            <th class="py-3 px-4">Title</th>
            <th class="py-3 px-4">Actions</th>
            <th class="py-3 px-4">SKU</th>
            <th class="py-3 px-4">Price</th>
            <th class="py-3 px-4">Platforms</th>
            <th class="py-3 px-4">Tone</th>
          </tr>
        </thead>
        <tbody id="listings-tbody" class="divide-y divide-[#F6F3EF]">
          <!-- Listings injected by JS -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- Listings Grid View -->
  <section id="listings-grid-section" class="px-8 pb-8 hidden">
    <div id="listings-grid" class="grid gap-6 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
      <!-- Cards injected by JS -->
    </div>
  </section>

  <!-- Buyer Psychology Map (Leaflet.js) -->
  <section class="max-w-xl px-8 pb-8">
    <h2 class="text-xl font-semibold mb-2">Buyer Psychology Map</h2>
    <div id="buyer-psychology-map" class="rounded-lg shadow overflow-hidden" style="height: 340px; max-width: 600px;"></div>
    <!-- Legend -->
    <div class="mt-2 flex flex-wrap gap-2 items-center text-sm">
      <span class="inline-flex items-center gap-1"><span class="inline-block w-4 h-4 rounded-full bg-[#F8D478]"></span> Cozy ☀️</span>
      <span class="inline-flex items-center gap-1"><span class="inline-block w-4 h-4 rounded-full bg-[#F7B4E1]"></span> Luxury 🧠</span>
      <span class="inline-flex items-center gap-1"><span class="inline-block w-4 h-4 rounded-full bg-[#B3E2CD]"></span> Eco 🍃</span>
      <span class="inline-flex items-center gap-1"><span class="inline-block w-4 h-4 rounded-full bg-[#E3E8F2]"></span> Minimalist 🧊</span>
      <span class="inline-flex items-center gap-1"><span class="inline-block w-4 h-4 rounded-full bg-[#F6E6C8]"></span> Budget 💰</span>
    </div>
  </section>

  <!-- Modals -->
  <div id="edit-modal" class="fixed inset-0 flex items-center justify-center bg-black/30 z-50 hidden">
    <div class="frosted rounded-xl shadow-xl p-8 max-w-xl w-full">
      <h3 class="text-lg font-semibold mb-4">Edit Listing</h3>
      <form id="edit-form" class="space-y-4">
        <input type="hidden" id="edit-id">
        <div>
          <label class="block text-sm mb-1">Title</label>
          <input id="edit-title" type="text" class="w-full rounded-lg bg-white border border-gray-200 px-3 py-2 outline-none">
        </div>
        <div>
          <label class="block text-sm mb-1">Price</label>
          <input id="edit-price" type="number" class="w-full rounded-lg bg-white border border-gray-200 px-3 py-2 outline-none">
        </div>
        <div>
          <label class="block text-sm mb-1">SKU</label>
          <input id="edit-sku" type="text" class="w-full rounded-lg bg-white border border-gray-200 px-3 py-2 outline-none">
        </div>
        <div class="flex gap-2 justify-end">
          <button type="button" class="bg-white px-4 py-2 rounded-lg text-[#E0985D] font-semibold hover:bg-[#F2C88A]" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="bg-gradient-to-r from-[#F2C88A] to-[#E0985D] text-[#2B2320] font-bold px-4 py-2 rounded-lg shadow hover:shadow-lg">Save</button>
        </div>
      </form>
    </div>
  </div>
  <div id="ai-modal" class="fixed inset-0 flex items-center justify-center bg-black/30 z-50 hidden">
    <div class="frosted rounded-xl shadow-xl p-8 max-w-xl w-full">
      <h3 class="text-lg font-semibold mb-4">AI Suggestions</h3>
      <div id="ai-suggestions" class="space-y-3">
        <!-- AI suggestions injected by JS -->
      </div>
      <div class="flex justify-end mt-4">
        <button class="bg-gradient-to-r from-[#F2C88A] to-[#E0985D] text-[#2B2320] font-bold px-4 py-2 rounded-lg shadow hover:shadow-lg" onclick="closeAIModal()">Close</button>
      </div>
    </div>
  </div>
  <div id="delete-modal" class="fixed inset-0 flex items-center justify-center bg-black/30 z-50 hidden">
    <div class="frosted rounded-xl shadow-xl p-8 max-w-sm w-full text-center">
      <h3 class="text-lg font-semibold mb-4">Delete Listing?</h3>
      <p class="mb-6">Are you sure you want to delete this listing? This action cannot be undone.</p>
      <div class="flex gap-2 justify-center">
        <button class="bg-white px-4 py-2 rounded-lg text-[#E0985D] font-semibold hover:bg-[#F2C88A]" onclick="closeDeleteModal()">Cancel</button>
        <button class="bg-gradient-to-r from-[#E0985D] to-[#F2C88A] text-[#2B2320] font-bold px-4 py-2 rounded-lg shadow hover:shadow-lg" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>
  <div id="comment-modal" class="fixed inset-0 flex items-center justify-center bg-black/30 z-50 hidden">
    <div class="frosted rounded-xl shadow-xl p-8 max-w-md w-full">
      <h3 class="text-lg font-semibold mb-4">Comments</h3>
      <p class="mb-4 text-gray-500">Annotation sidebar coming soon.</p>
      <div class="flex justify-end">
        <button class="bg-gradient-to-r from-[#F2C88A] to-[#E0985D] text-[#2B2320] font-bold px-4 py-2 rounded-lg shadow hover:shadow-lg" onclick="closeCommentModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="mt-auto bg-[#FAF7F2] px-8 py-8">
    <div class="flex flex-wrap items-center justify-between max-w-5xl mx-auto">
      <div class="flex gap-4">
        <img src="/assets/trust-badge1.png" alt="Trust 1" class="h-8">
        <img src="/assets/trust-badge2.png" alt="Trust 2" class="h-8">
        <img src="/assets/trust-badge3.png" alt="Trust 3" class="h-8">
      </div>
      <span class="text-sm text-[#2B2320] font-light">AutoList Canada © 2025 — Built with trust, science, and Canadian soul 🇨🇦</span>
    </div>
  </footer>
</main>

<!-- SVG wave divider -->
<svg class="wave-divider" viewBox="0 0 1440 40" fill="none" preserveAspectRatio="none"><path d="M0,20 C360,60 1080,0 1440,20 L1440,40 L0,40 Z" fill="#FAF7F2"/></svg>

<script>
  // --- Brand Tone Colors ---
  const TONE_COLORS = {
    'Cozy': '#F8D478',           // ☀️
    'Luxury': '#F7B4E1',         // 🧠
    'Eco': '#B3E2CD',            // 🍃
    'Minimalist': '#E3E8F2',     // 🧊
    'Sporty': '#B7D0F8',
    'Budget': '#F6E6C8'
  };
  const TONE_EMOJIS = {
    'Cozy': '☀️',
    'Luxury': '🧠',
    'Eco': '🍃',
    'Minimalist': '🧊',
    'Sporty': '🏃',
    'Budget': '💰'
  };

  // --- Marketplace Connection State ---
  let connections = {
    'eBay': false,
    'Poshmark': false,
    'Facebook': false
  };

  // Listings Data (in-memory demo, replace with live API)
  let listings = [];

  // --- Marketplace OAuth Simulation ---
  function connectMarketplace(platform) {
    // Simulate OAuth
    const btn = document.getElementById(platform.toLowerCase() + '-btn');
    const status = document.getElementById(platform.toLowerCase() + '-status');
    btn.classList.remove('bg-gradient-to-r', 'from-[#E0985D]', 'to-[#F2C88A]');
    btn.classList.add('bg-gradient-to-r', 'from-green-400', 'to-green-600');
    status.textContent = 'Connected ✅';
    connections[platform] = true;

    // On eBay connect, sync listings
    if (platform === 'eBay') {
      document.getElementById('connect-prompt').classList.add('hidden');
      syncEbayListings();
    }
  }

  // --- Listings Sync (eBay) ---
  function syncEbayListings() {
    document.getElementById('sync-loading').classList.remove('hidden');
    setTimeout(() => {
      // Simulate live API: GET /inventory
      listings = [
        {
          id: 'ebay-001',
          image: '/assets/listing1.jpg',
          title: 'Vintage Wool Sweater',
          price: 59.99,
          sku: 'VW123',
          platforms: {eBay: true, Poshmark: false, Facebook: false},
          tone: 'Cozy',
          lastUpdated: '2025-06-26T10:00:00Z',
          sold: false
        },
        {
          id: 'ebay-002',
          image: '/assets/listing2.jpg',
          title: 'Eco Denim Jacket',
          price: 48.50,
          sku: 'EDJ88',
          platforms: {eBay: true, Poshmark: true, Facebook: false},
          tone: 'Eco',
          lastUpdated: '2025-06-25T09:00:00Z',
          sold: true
        },
        {
          id: 'ebay-003',
          image: '/assets/listing3.jpg',
          title: 'Minimalist Canvas Tote',
          price: 29.95,
          sku: 'MCT456',
          platforms: {eBay: true, Poshmark: false, Facebook: true},
          tone: 'Minimalist',
          lastUpdated: '2025-06-24T11:00:00Z',
          sold: false
        },
        {
          id: 'ebay-004',
          image: '',
          title: 'Luxury Silk Scarf',
          price: 120.00,
          sku: 'LSS999',
          platforms: {eBay: true, Poshmark: true, Facebook: true},
          tone: 'Luxury',
          lastUpdated: '2025-06-27T08:50:00Z',
          sold: false
        }
      ];
      document.getElementById('sync-loading').classList.add('hidden');
      renderListings();
    }, 1200);
  }

  // --- Render Listings ---
  let listView = true;

  function renderListings() {
    // Filtering logic
    const search = document.getElementById('search').value.toLowerCase();
    const platformFilter = document.getElementById('platform-filter').value;
    const toneFilter = document.getElementById('tone-filter').value;
    const hideSold = document.getElementById('hide-sold').checked;

    let filtered = listings.filter(l => {
      if (search && !l.title.toLowerCase().includes(search)) return false;
      if (platformFilter && !l.platforms[platformFilter]) return false;
      if (toneFilter && l.tone !== toneFilter) return false;
      if (hideSold && l.sold) return false;
      return true;
    });

    // Sort: latest updated first
    filtered.sort((a, b) => (new Date(b.lastUpdated) - new Date(a.lastUpdated)) || a.title.localeCompare(b.title));

    // List View
    if (listView) {
      document.getElementById('listings-list-section').classList.remove('hidden');
      document.getElementById('listings-grid-section').classList.add('hidden');
      const tbody = document.getElementById('listings-tbody');
      tbody.innerHTML = '';
      filtered.forEach(l => {
        tbody.innerHTML += `
          <tr class="hover:bg-[#FAF7F2] transition">
            <td class="py-2 px-4">
              <img src="${l.image || '/assets/image-placeholder.png'}" alt="Listing" class="w-14 h-14 object-cover rounded shadow border border-gray-100" onerror="this.onerror=null;this.src='/assets/image-placeholder.png';">
            </td>
            <td class="py-2 px-4 font-semibold">${l.title}${l.sold ? ' <span class="ml-2 text-xs rounded px-2 py-1 bg-[#F6E6C8] text-[#7A5C2E]">SOLD</span>' : ''}</td>
            <td class="py-2 px-4 flex gap-2">
              <button class="p-2 rounded hover:bg-[#F2C88A]" onclick="openEditModal('${l.id}')">✏️</button>
              <button class="p-2 rounded hover:bg-[#F2C88A]" onclick="openDeleteModal('${l.id}')">🗑️</button>
              <button class="p-2 rounded hover:bg-[#F2C88A]" onclick="openAIModal('${l.id}')">⚡</button>
              <button class="p-2 rounded hover:bg-[#F2C88A]" onclick="openCommentModal('${l.id}')">💬</button>
            </td>
            <td class="py-2 px-4">${l.sku}</td>
            <td class="py-2 px-4">$${l.price.toFixed(2)}</td>
            <td class="py-2 px-4 flex gap-1 items-center">
              ${platformIcon('eBay', l.platforms.eBay)}
              ${platformIcon('Poshmark', l.platforms.Poshmark)}
              ${platformIcon('Facebook', l.platforms.Facebook)}
            </td>
            <td class="py-2 px-4">
              <span class="inline-block px-2 py-1 rounded-full font-medium" style="background:${TONE_COLORS[l.tone] || '#EEE'}">
                ${l.tone} ${TONE_EMOJIS[l.tone] || ''}
              </span>
            </td>
          </tr>
        `;
      });
    } else {
      // Grid View
      document.getElementById('listings-list-section').classList.add('hidden');
      document.getElementById('listings-grid-section').classList.remove('hidden');
      const grid = document.getElementById('listings-grid');
      grid.innerHTML = '';
      filtered.forEach(l => {
        grid.innerHTML += `
          <div class="bg-white rounded-xl shadow p-4 flex flex-col card-animate">
            <img src="${l.image || '/assets/image-placeholder.png'}" alt="Listing" class="w-full h-40 object-cover rounded mb-2" onerror="this.onerror=null;this.src='/assets/image-placeholder.png';">
            <div class="flex-1">
              <div class="font-semibold text-lg mb-1">${l.title}${l.sold ? ' <span class="ml-2 text-xs rounded px-2 py-1 bg-[#F6E6C8] text-[#7A5C2E]">SOLD</span>' : ''}</div>
              <div class="text-sm mb-1 flex gap-1">
                ${platformIcon('eBay', l.platforms.eBay)}
                ${platformIcon('Poshmark', l.platforms.Poshmark)}
                ${platformIcon('Facebook', l.platforms.Facebook)}
              </div>
              <div class="mt-2 flex gap-2">
                <button class="bg-gradient-to-r from-[#F2C88A] to-[#E0985D] text-[#2B2320] font-bold px-3 py-1 rounded shadow hover:shadow-lg" onclick="openAIModal('${l.id}')">Fix Title</button>
                <button class="bg-gradient-to-r from-[#E0985D] to-[#F2C88A] text-[#2B2320] font-bold px-3 py-1 rounded shadow hover:shadow-lg" onclick="openAIModal('${l.id}')">Edit Description</button>
              </div>
            </div>
            <div class="mt-3">
              <span class="inline-block px-2 py-1 rounded-full font-medium" style="background:${TONE_COLORS[l.tone] || '#EEE'}">
                ${l.tone} ${TONE_EMOJIS[l.tone] || ''}
              </span>
            </div>
          </div>
        `;
      });
    }
  }

  function platformIcon(platform, checked) {
    let iconSrc = {
      eBay: '/assets/ebay-logo.png',
      Poshmark: '/assets/poshmark-logo.png',
      Facebook: '/assets/facebook-logo.png'
    }[platform];
    return `<label class="flex items-center gap-1 mr-2"><input type="checkbox" class="accent-[#E0985D]" ${checked ? 'checked' : ''} onchange="togglePlatform('${platform}', this.checked)"><img src="${iconSrc}" alt="${platform}" class="w-5 h-5"></label>`;
  }
  function togglePlatform(platform, checked) {
    // Noop for demo; in production, update listing's platform sync
  }

  // --- Modal Logic ---
  let currentEditId = null;
  let currentDeleteId = null;

  function openEditModal(id) {
    currentEditId = id;
    const l = listings.find(l => l.id === id);
    document.getElementById('edit-id').value = l.id;
    document.getElementById('edit-title').value = l.title;
    document.getElementById('edit-price').value = l.price;
    document.getElementById('edit-sku').value = l.sku;
    document.getElementById('edit-modal').classList.remove('hidden');
  }
  function closeEditModal() {
    document.getElementById('edit-modal').classList.add('hidden');
    currentEditId = null;
  }
  document.getElementById('edit-form').onsubmit = function(e){
    e.preventDefault();
    const id = document.getElementById('edit-id').value;
    const l = listings.find(l => l.id === id);
    l.title = document.getElementById('edit-title').value;
    l.price = parseFloat(document.getElementById('edit-price').value);
    l.sku = document.getElementById('edit-sku').value;
    closeEditModal();
    renderListings();
  }

  function openDeleteModal(id) {
    currentDeleteId = id;
    document.getElementById('delete-modal').classList.remove('hidden');
  }
  function closeDeleteModal() {
    document.getElementById('delete-modal').classList.add('hidden');
    currentDeleteId = null;
  }
  function confirmDelete() {
    listings = listings.filter(l => l.id !== currentDeleteId);
    closeDeleteModal();
    renderListings();
  }

  function openAIModal(id) {
    const l = listings.find(l => l.id === id);
    document.getElementById('ai-suggestions').innerHTML = `
      <div class="bg-[#F6F3EF] rounded-lg p-4 shadow">
        <div class="font-semibold mb-1">AI Title Suggestion:</div>
        <div class="text-[#E0985D] mb-1">"${generateAITitle(l.title)}"</div>
        <button onclick="applyAItitle('${id}')" class="bg-gradient-to-r from-[#F2C88A] to-[#E0985D] text-[#2B2320] font-bold px-3 py-1 rounded shadow hover:shadow-lg">Apply</button>
      </div>
      <div class="bg-[#F6F3EF] rounded-lg p-4 shadow">
        <div class="font-semibold mb-1">AI Description Suggestion:</div>
        <div class="text-gray-700 mb-1">${generateAIDesc(l)}</div>
      </div>
    `;
    document.getElementById('ai-modal').classList.remove('hidden');
  }
  function closeAIModal() {
    document.getElementById('ai-modal').classList.add('hidden');
  }
  function applyAItitle(id) {
    const l = listings.find(l => l.id === id);
    l.title = generateAITitle(l.title);
    closeAIModal();
    renderListings();
  }
  function generateAITitle(title) {
    // Simple AI: add adjectives based on tone
    const adj = {
      'Cozy': 'Warm',
      'Luxury': 'Elegant',
      'Eco': 'Sustainable',
      'Minimalist': 'Simple',
      'Sporty': 'Active',
      'Budget': 'Affordable'
    };
    const l = listings.find(l => l.title === title);
    let prefix = l && l.tone && adj[l.tone] ? adj[l.tone] + ' ' : '';
    return prefix + title;
  }
  function generateAIDesc(l) {
    // Simple AI: contextual description
    return `This ${l.tone ? l.tone.toLowerCase() : ''} piece is perfect for your Canadian wardrobe. Ships fast from trusted seller.`;
  }

  function openCommentModal(id) {
    document.getElementById('comment-modal').classList.remove('hidden');
  }
  function closeCommentModal() {
    document.getElementById('comment-modal').classList.add('hidden');
  }

  // --- UI Event Listeners ---
  document.getElementById('search').oninput =
    document.getElementById('platform-filter').onchange =
    document.getElementById('tone-filter').onchange =
    document.getElementById('hide-sold').onchange =
    () => renderListings();

  document.getElementById('list-view-btn').onclick = function() {
    listView = true;
    this.classList.add('bg-[#E0985D]', 'text-white');
    document.getElementById('grid-view-btn').classList.remove('bg-[#E0985D]', 'text-white');
    document.getElementById('grid-view-btn').classList.add('bg-white', 'text-[#E0985D]');
    renderListings();
  };
  document.getElementById('grid-view-btn').onclick = function() {
    listView = false;
    this.classList.add('bg-[#E0985D]', 'text-white');
    document.getElementById('list-view-btn').classList.remove('bg-[#E0985D]', 'text-white');
    document.getElementById('list-view-btn').classList.add('bg-white', 'text-[#E0985D]');
    renderListings();
  };

  // --- Language Toggle ---
  document.getElementById('lang-toggle').onclick = function(){
    // For demo only; in production, switch language
    alert('Français coming soon!');
  };

  // --- Initial State ---
  window.onload = function() {
    // eBay connection check (simulate not connected)
    if (!connections['eBay']) {
      document.getElementById('connect-prompt').classList.remove('hidden');
    } else {
      syncEbayListings();
    }
    // Map
    setupBuyerPsychologyMap();
  };

  // --- Leaflet.js: Buyer Psychology Map ---
  function setupBuyerPsychologyMap() {
    const map = L.map('buyer-psychology-map', {
      center: [54, -96.5],
      zoom: 3.3,
      zoomControl: false,
      scrollWheelZoom: false,
      dragging: true
    });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: ''}).addTo(map);

    // Regions
    const regions = [
      { name: 'Quebec', coord: [46.8, -71.2], tone: 'Cozy' },
      { name: 'BC', coord: [49.2, -123.1], tone: 'Minimalist' },
      { name: 'Prairies', coord: [53.5, -113.5], tone: 'Cozy' },
      { name: 'Toronto', coord: [43.7, -79.4], tone: 'Luxury' },
      { name: 'Maritimes', coord: [45.4, -63.2], tone: 'Budget' }
    ];
    regions.forEach(r => {
      L.circleMarker(r.coord, {
        radius: 18,
        color: TONE_COLORS[r.tone],
        fillColor: TONE_COLORS[r.tone],
        fillOpacity: 0.45,
        weight: 7
      }).addTo(map)
        .bindTooltip(`${r.name} (${r.tone} ${TONE_EMOJIS[r.tone]})`, {permanent: false});
    });
  }
</script>
</body>
</html>

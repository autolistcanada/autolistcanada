<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AutoList Canada Listings Dashboard</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN (for analytics) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Leaflet CDN (for map heatmap) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Platform Icons (FontAwesome) -->
  <script src="https://kit.fontawesome.com/fb5e1c7ad3.js" crossorigin="anonymous"></script>
  <style>
    .sidebar-bg {
      background: url('sidebar-background.png') no-repeat center center;
      background-size: cover;
    }
    .fade-sold {
      opacity: 0.5;
      position: relative;
    }
    .fade-sold::after {
      content: 'SOLD';
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      background: #e3342f;
      color: #fff;
      font-size: 0.8rem;
      font-weight: bold;
      padding: 2px 8px;
      border-radius: 4px;
      z-index: 10;
    }
    .leaflet-container { height: 200px; }
    .platform-toggle input:checked + span {
      background-color: #22d3ee !important;
      color: #fff !important;
    }
    .modal-bg {
      background: rgba(0,0,0,0.45);
    }
    /* Custom scrollbar for sidebar */
    ::-webkit-scrollbar {
      width: 8px;
      background: #CAD3E2;
    }
    ::-webkit-scrollbar-thumb {
      background: #64748b;
      border-radius: 8px;
    }
  </style>
</head>
<body class="h-full flex flex-col min-h-screen">

<!-- Sidebar -->
<div class="sidebar-bg fixed inset-y-0 left-0 w-64 flex flex-col z-30 shadow-xl">
  <div class="flex items-center gap-3 h-20 px-6 pt-4">
    <img src="logo.png" alt="AutoList Logo" class="w-10 h-10 rounded-full bg-white shadow"/>
    <img src="autolist-title.png" alt="AutoList Canada" class="h-8"/>
  </div>
  <nav class="flex-1 mt-8 px-4 space-y-2 text-lg font-semibold text-gray-800 overflow-y-auto">
    <a href="#" class="block py-2 px-3 rounded-lg hover:bg-cyan-100 flex items-center gap-2"><i class="fa-solid fa-gauge"></i> Dashboard</a>
    <a href="#" class="block py-2 px-3 rounded-lg bg-cyan-700 text-white flex items-center gap-2"><i class="fa-solid fa-table-list"></i> Listings</a>
    <a href="#" class="block py-2 px-3 rounded-lg hover:bg-cyan-100 flex items-center gap-2"><i class="fa-solid fa-robot"></i> AI Tools</a>
    <a href="#" class="block py-2 px-3 rounded-lg hover:bg-cyan-100 flex items-center gap-2"><i class="fa-solid fa-lightbulb"></i> How It Works</a>
    <a href="#" class="block py-2 px-3 rounded-lg hover:bg-cyan-100 flex items-center gap-2"><i class="fa-solid fa-circle-question"></i> FAQ</a>
    <a href="#" class="block py-2 px-3 rounded-lg hover:bg-cyan-100 flex items-center gap-2"><i class="fa-solid fa-upload"></i> Import</a>
    <a href="#" class="block py-2 px-3 rounded-lg hover:bg-cyan-100 flex items-center gap-2"><i class="fa-solid fa-scale-balanced"></i> Terms</a>
    <a href="#" class="block py-2 px-3 rounded-lg hover:bg-cyan-100 flex items-center gap-2"><i class="fa-solid fa-tags"></i> Pricing</a>
  </nav>
  <div class="mt-auto mb-4 px-4">
    <a href="https://autolist.ca" class="block text-center text-xs text-gray-400 hover:underline">AutoList Canada &copy; 2025</a>
  </div>
</div>

<!-- Main Content Area -->
<div class="pl-64 flex flex-col min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow sticky top-0 z-20">
    <div class="flex flex-col md:flex-row md:items-center justify-between px-6 py-4 gap-3">
      <div class="flex-1 flex items-center gap-3">
        <div class="relative w-full max-w-xs">
          <input id="searchBar" type="text" placeholder="Search listings..." class="w-full pl-10 pr-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-cyan-400" />
          <span class="absolute left-3 top-2.5 text-gray-400"><i class="fa fa-search"></i></span>
        </div>
        <select id="filterPlatform" class="ml-2 border rounded px-2 py-1 text-gray-700">
          <option value="">All Platforms</option>
          <option value="ebay">eBay</option>
          <option value="poshmark">Poshmark</option>
          <option value="etsy">Etsy</option>
          <option value="facebook">Facebook Marketplace</option>
          <option value="shopify">Shopify</option>
          <option value="depop">Depop</option>
          <option value="grailed">Grailed</option>
        </select>
        <select id="perPage" class="ml-2 border rounded px-2 py-1 text-gray-700">
          <option>8</option>
          <option>16</option>
          <option>32</option>
        </select>
        <span id="pageStatus" class="ml-3 text-sm text-gray-500">1 of 2</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="customizeBtn" class="bg-cyan-500 hover:bg-cyan-700 text-white px-3 py-1 rounded shadow flex items-center gap-1"><i class="fa fa-sliders"></i> Customize</button>
        <button id="bulkEditBtn" class="bg-orange-400 hover:bg-orange-600 text-white px-3 py-1 rounded shadow flex items-center gap-1"><i class="fa fa-edit"></i> Bulk Edit</button>
        <label class="flex items-center gap-1 ml-4 cursor-pointer">
          <input type="checkbox" id="wideViewToggle" class="hidden peer" />
          <span class="peer-checked:bg-cyan-600 peer-checked:text-white text-cyan-600 border border-cyan-600 px-2 py-1 rounded transition">Wide View</span>
        </label>
        <label class="flex items-center gap-1 ml-2 cursor-pointer">
          <input type="checkbox" id="hideSoldToggle" class="hidden peer" />
          <span class="peer-checked:bg-orange-600 peer-checked:text-white text-orange-600 border border-orange-600 px-2 py-1 rounded transition">Hide Sold</span>
        </label>
        <span class="ml-4 text-gray-700 font-semibold hidden md:inline">Welcome back, <span id="userName">Einstein</span>!</span>
      </div>
    </div>
  </header>

  <!-- Main Section -->
  <main class="flex-1 flex flex-col lg:flex-row gap-6 p-6">
    <!-- Listings Data Table -->
    <section class="flex-1 bg-white rounded-xl shadow-lg overflow-x-auto min-w-[400px]">
      <table class="min-w-full text-sm" id="listingsTable">
        <thead class="bg-cyan-700 text-white">
          <tr>
            <th class="p-3 text-left">Image</th>
            <th class="p-3 text-left">Title</th>
            <th class="p-3 text-center">Actions</th>
            <th class="p-3 text-left">SKU</th>
            <th class="p-3 text-right">Price</th>
            <th class="p-3 text-center">Platforms</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- JS will populate -->
        </tbody>
      </table>
      <div class="flex justify-between items-center p-4 border-t">
        <button id="prevPage" class="px-3 py-1 bg-gray-200 rounded hover:bg-cyan-100"><i class="fa fa-arrow-left"></i> Prev</button>
        <button id="nextPage" class="px-3 py-1 bg-gray-200 rounded hover:bg-cyan-100">Next <i class="fa fa-arrow-right"></i></button>
      </div>
    </section>

    <!-- Analytics + Map Panel -->
    <aside class="w-full lg:w-[350px] flex flex-col gap-6">
      <div class="bg-white rounded-xl shadow-lg p-4">
        <h3 class="font-bold text-cyan-700 mb-2 text-lg">Sales Psychology Map</h3>
        <div id="canadaMap" class="w-full h-[200px] rounded overflow-hidden"></div>
      </div>
      <div class="bg-white rounded-xl shadow-lg p-4">
        <h3 class="font-bold text-cyan-700 mb-2 text-lg">World Market Analytics</h3>
        <canvas id="worldChart" width="360" height="120"></canvas>
      </div>
    </aside>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white mt-auto">
    <div class="max-w-7xl mx-auto py-4 px-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
      <div>
        <div class="bg-gray-800 rounded px-2 py-1 mb-1 text-xs inline-block">Misc AI Listing Adjustments</div>
        <span class="bg-cyan-700 rounded px-2 py-1 text-xs font-bold ml-2">Our Tools for Listing Dashboard</span>
      </div>
      <div class="text-xs text-gray-300 flex flex-col md:flex-row md:gap-2 items-start md:items-center">
        <a href="#" class="hover:underline">All Rights Reserved</a>
        <a href="#" class="hover:underline">Privacy</a>
        <a href="#" class="hover:underline">Terms of Service</a>
        <span class="ml-2">Canadian Legal: PIPEDA-compliant. No scraping. ðŸ‡¨ðŸ‡¦</span>
      </div>
    </div>
  </footer>

  <!-- Edit Listing Modal -->
  <div id="editModal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-bg">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative">
      <button id="closeModal" class="absolute right-4 top-4 text-gray-500 hover:text-cyan-700 text-xl"><i class="fa fa-times"></i></button>
      <h2 class="text-xl font-bold mb-4 text-cyan-700">Edit Listing</h2>
      <form id="editForm" class="space-y-3">
        <div>
          <label class="block text-sm font-semibold text-gray-700">Title</label>
          <input type="text" id="editTitle" class="w-full rounded border px-2 py-1" required>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700">Price</label>
          <input type="number" id="editPrice" class="w-full rounded border px-2 py-1" min="0" step="0.01" required>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700">Tags (comma-separated)</label>
          <input type="text" id="editTags" class="w-full rounded border px-2 py-1">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Platforms</label>
          <div id="editPlatforms" class="flex flex-wrap gap-2">
            <!-- JS will fill -->
          </div>
        </div>
        <div class="flex gap-2 justify-end pt-3">
          <button type="button" class="px-4 py-1 rounded bg-gray-200 hover:bg-gray-300" id="cancelEdit">Cancel</button>
          <button type="submit" class="px-4 py-1 rounded bg-cyan-700 text-white hover:bg-cyan-800">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div id="deleteModal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-bg">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative">
      <button id="closeDelete" class="absolute right-4 top-4 text-gray-500 hover:text-red-700 text-xl"><i class="fa fa-times"></i></button>
      <h2 class="text-xl font-bold mb-4 text-red-700">Delete Listing?</h2>
      <p class="mb-6 text-gray-700">Are you sure you want to delete this listing? This action cannot be undone.</p>
      <div class="flex gap-2 justify-end">
        <button class="px-4 py-1 rounded bg-gray-200 hover:bg-gray-300" id="cancelDelete">Cancel</button>
        <button class="px-4 py-1 rounded bg-red-600 text-white hover:bg-red-800" id="confirmDelete">Delete</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========== DUMMY DATA ========== */
const platformsAll = [
  {id:'ebay', name:'eBay', icon:'fa-brands fa-ebay', color:'text-[#0064d2]'},
  {id:'poshmark', name:'Poshmark', icon:'fa-solid fa-p', color:'text-rose-500'},
  {id:'etsy', name:'Etsy', icon:'fa-brands fa-etsy', color:'text-orange-600'},
  {id:'facebook', name:'Facebook', icon:'fa-brands fa-facebook', color:'text-blue-600'},
  {id:'shopify', name:'Shopify', icon:'fa-brands fa-shopify', color:'text-green-600'},
  {id:'depop', name:'Depop', icon:'fa-solid fa-d', color:'text-red-500'},
  {id:'grailed', name:'Grailed', icon:'fa-solid fa-g', color:'text-gray-700'},
];
let listings = [
  {
    id:"1", title:"Rare 80s Leviâ€™s 501 Jeans", img:"https://i.imgur.com/Jeans1.jpg", sku:"SKU12345", price:180.00, tags:["vintage","denim"], sold:false,
    platforms:{ebay:true, poshmark:true, etsy:false, facebook:true, shopify:false, depop:false, grailed:false}
  },
  {
    id:"2", title:"Champion Toronto Raptors Hoodie", img:"https://i.imgur.com/Hoodie1.jpg", sku:"SKU12346", price:75.00, tags:["sportswear"], sold:true,
    platforms:{ebay:false, poshmark:true, etsy:true, facebook:false, shopify:true, depop:false, grailed:true}
  },
  {
    id:"3", title:"Vintage Roots Canada Crewneck", img:"https://i.imgur.com/Roots1.jpg", sku:"SKU12347", price:110.00, tags:["roots","canadian"], sold:false,
    platforms:{ebay:true, poshmark:true, etsy:true, facebook:false, shopify:false, depop:true, grailed:false}
  },
  {
    id:"4", title:"Y2K Nike Air Max Sneakers", img:"https://i.imgur.com/Nike1.jpg", sku:"SKU12348", price:220.00, tags:["y2k","sneakers"], sold:false,
    platforms:{ebay:true, poshmark:false, etsy:true, facebook:true, shopify:true, depop:false, grailed:true}
  },
  {
    id:"5", title:"Etsy-Ready Upcycled Flannel", img:"https://i.imgur.com/Flannel1.jpg", sku:"SKU12349", price:60.00, tags:["flannel"], sold:true,
    platforms:{ebay:false, poshmark:false, etsy:true, facebook:false, shopify:false, depop:true, grailed:false}
  },
  {
    id:"6", title:"Grailed Supreme Box Logo Tee", img:"https://i.imgur.com/Supreme1.jpg", sku:"SKU12350", price:500.00, tags:["supreme"], sold:false,
    platforms:{ebay:false, poshmark:false, etsy:false, facebook:false, shopify:true, depop:false, grailed:true}
  },
  {
    id:"7", title:"Poshmark Adidas Track Jacket", img:"https://i.imgur.com/Adidas1.jpg", sku:"SKU12351", price:95.00, tags:["adidas"], sold:false,
    platforms:{ebay:true, poshmark:true, etsy:false, facebook:true, shopify:false, depop:false, grailed:false}
  },
  {
    id:"8", title:"Depop Doc Martens Boots", img:"https://i.imgur.com/Docs1.jpg", sku:"SKU12352", price:150.00, tags:["boots"], sold:false,
    platforms:{ebay:false, poshmark:false, etsy:false, facebook:true, shopify:false, depop:true, grailed:false}
  },
  {
    id:"9", title:"Shopify â€˜90s Patagonia Fleece", img:"https://i.imgur.com/Patagonia1.jpg", sku:"SKU12353", price:125.00, tags:["patagonia"], sold:true,
    platforms:{ebay:true, poshmark:false, etsy:false, facebook:false, shopify:true, depop:false, grailed:false}
  },
  {
    id:"10", title:"Canadian Olympic Parka", img:"https://i.imgur.com/Parka1.jpg", sku:"SKU12354", price:140.00, tags:["olympic"], sold:false,
    platforms:{ebay:true, poshmark:true, etsy:true, facebook:false, shopify:false, depop:false, grailed:true}
  },
  {
    id:"11", title:"Vintage Montreal Expos Cap", img:"https://i.imgur.com/Expos1.jpg", sku:"SKU12355", price:55.00, tags:["expos"], sold:false,
    platforms:{ebay:true, poshmark:false, etsy:false, facebook:true, shopify:false, depop:true, grailed:false}
  },
  {
    id:"12", title:"Rare Grailed Comme des GarÃ§ons", img:"https://i.imgur.com/Garcons1.jpg", sku:"SKU12356", price:350.00, tags:["cdg"], sold:true,
    platforms:{ebay:false, poshmark:false, etsy:false, facebook:false, shopify:false, depop:false, grailed:true}
  },
  {
    id:"13", title:"Etsy Retro Leather Satchel", img:"https://i.imgur.com/Satchel1.jpg", sku:"SKU12357", price:105.00, tags:["leather"], sold:false,
    platforms:{ebay:true, poshmark:false, etsy:true, facebook:true, shopify:false, depop:false, grailed:false}
  },
  {
    id:"14", title:"Denim Overalls - Y2K Vibes", img:"https://i.imgur.com/Overalls1.jpg", sku:"SKU12358", price:88.00, tags:["denim"], sold:false,
    platforms:{ebay:true, poshmark:true, etsy:false, facebook:false, shopify:false, depop:false, grailed:false}
  },
  {
    id:"15", title:"Shopify Modernist Wool Scarf", img:"https://i.imgur.com/Scarf1.jpg", sku:"SKU12359", price:40.00, tags:["wool"], sold:false,
    platforms:{ebay:false, poshmark:false, etsy:true, facebook:true, shopify:true, depop:false, grailed:false}
  },
  {
    id:"16", title:"Etsy Patchwork Quilt", img:"https://i.imgur.com/Quilt1.jpg", sku:"SKU12360", price:95.00, tags:["quilt"], sold:false,
    platforms:{ebay:false, poshmark:false, etsy:true, facebook:true, shopify:false, depop:false, grailed:false}
  }
];
let userName = "Einstein";

/* ========== PAGINATION / FILTER STATE ========== */
let page = 1;
let perPage = 8;
let filterPlatform = "";
let searchTerm = "";
let hideSold = false;

/* ========== UTILS ========== */
function getPlatformIcon(id) {
  let p = platformsAll.find(x=>x.id===id);
  if (!p) return '';
  return `<span class="${p.color} text-xl mr-1" title="${p.name}"><i class="${p.icon}"></i></span>`;
}

/* ========== TABLE RENDERING ========== */
function renderTable() {
  let filtered = listings.filter(l => {
    if (hideSold && l.sold) return false;
    if (filterPlatform && !l.platforms[filterPlatform]) return false;
    if (searchTerm && !l.title.toLowerCase().includes(searchTerm.toLowerCase()) && !l.sku.toLowerCase().includes(searchTerm.toLowerCase())) return false;
    return true;
  });
  let totalPages = Math.ceil(filtered.length / perPage);
  if (page > totalPages) page = totalPages || 1;
  document.getElementById('pageStatus').textContent = `${page} of ${totalPages || 1}`;
  // paging
  let start = (page-1)*perPage, end = start+perPage;
  let rows = filtered.slice(start, end).map(l => `
    <tr class="group ${l.sold ? 'fade-sold' : ''} cursor-pointer hover:bg-cyan-50 transition" data-id="${l.id}">
      <td class="p-2 w-[66px]" onclick="event.stopPropagation();openModal('${l.id}')">
        <img src="${l.img}" alt="${l.title}" class="w-14 h-14 rounded shadow object-cover border"/>
      </td>
      <td class="p-2" onclick="event.stopPropagation();openModal('${l.id}')">
        <div class="font-semibold">${l.title}</div>
        <div class="text-xs text-gray-500">${l.tags.join(", ")}</div>
      </td>
      <td class="p-2 text-center">
        <button title="Edit" onclick="event.stopPropagation();openModal('${l.id}')" class="text-cyan-700 hover:text-cyan-900 px-1"><i class="fa fa-pen"></i></button>
        <button title="Sync" onclick="event.stopPropagation();syncListing('${l.id}')" class="text-green-600 hover:text-green-800 px-1"><i class="fa fa-arrows-rotate"></i></button>
        <button title="Clone" onclick="event.stopPropagation();cloneListing('${l.id}')" class="text-purple-500 hover:text-purple-700 px-1"><i class="fa fa-copy"></i></button>
        <button title="Delete" onclick="event.stopPropagation();openDelete('${l.id}')" class="text-red-600 hover:text-red-800 px-1"><i class="fa fa-trash"></i></button>
      </td>
      <td class="p-2 text-xs" onclick="event.stopPropagation();openModal('${l.id}')">${l.sku}</td>
      <td class="p-2 text-right font-mono" onclick="event.stopPropagation();openModal('${l.id}')">$${l.price.toFixed(2)}</td>
      <td class="p-2 text-center flex flex-wrap gap-1 justify-center" onclick="event.stopPropagation();openModal('${l.id}')">
        ${platformsAll.map(p => l.platforms[p.id] ? getPlatformIcon(p.id) : '').join('')}
      </td>
    </tr>
  `).join("");
  document.getElementById('tableBody').innerHTML = rows || `<tr><td colspan="6" class="text-center p-8 text-gray-400">No listings found.</td></tr>`;
}
window.renderTable = renderTable; // for button onclick in HTML

/* ========== MODAL LOGIC ========== */
let editingId = null;
function openModal(id) {
  editingId = id;
  let l = listings.find(x=>x.id===id);
  if (!l) return;
  document.getElementById('editTitle').value = l.title;
  document.getElementById('editPrice').value = l.price;
  document.getElementById('editTags').value = l.tags.join(", ");
  let plats = platformsAll.map(p => `
    <label class="inline-flex items-center mr-3 platform-toggle">
      <input type="checkbox" class="hidden" data-platform="${p.id}" ${l.platforms[p.id] ? 'checked' : ''}>
      <span class="p-1 rounded cursor-pointer border ${p.color} text-lg" title="${p.name}"><i class="${p.icon}"></i></span>
    </label>
  `).join('');
  document.getElementById('editPlatforms').innerHTML = plats;
  document.getElementById('editModal').classList.remove('hidden');
}
window.openModal = openModal;

document.getElementById('closeModal').onclick = 
document.getElementById('cancelEdit').onclick = function() {
  document.getElementById('editModal').classList.add('hidden');
};

document.getElementById('editForm').onsubmit = function(e) {
  e.preventDefault();
  let l = listings.find(x=>x.id===editingId);
  if (!l) return;
  l.title = document.getElementById('editTitle').value.trim();
  l.price = parseFloat(document.getElementById('editPrice').value);
  l.tags = document.getElementById('editTags').value.split(',').map(t=>t.trim()).filter(Boolean);
  // platforms
  document.querySelectorAll('#editPlatforms input[type=checkbox]').forEach(cb => {
    l.platforms[cb.dataset.platform] = cb.checked;
  });
  document.getElementById('editModal').classList.add('hidden');
  renderTable();
};

document.getElementById('editPlatforms').onclick = function(e) {
  // Toggle visual feedback
  if (e.target.closest('label')) {
    let inp = e.target.closest('label').querySelector('input[type="checkbox"]');
    inp.checked = !inp.checked;
    inp.dispatchEvent(new Event('change'));
  }
};

/* ========== DELETE MODAL ========== */
let deletingId = null;
function openDelete(id) {
  deletingId = id;
  document.getElementById('deleteModal').classList.remove('hidden');
}
window.openDelete = openDelete;

document.getElementById('closeDelete').onclick = 
document.getElementById('cancelDelete').onclick = function() {
  document.getElementById('deleteModal').classList.add('hidden');
};
document.getElementById('confirmDelete').onclick = function() {
  listings = listings.filter(x=>x.id!==deletingId);
  deletingId = null;
  document.getElementById('deleteModal').classList.add('hidden');
  renderTable();
};

/* ========== ACTION BUTTONS ========== */
function syncListing(id) {
  alert('Sync triggered for listing #' + id + ' (OAuth logic simulated)');
}
window.syncListing = syncListing;

function cloneListing(id) {
  let l = listings.find(x=>x.id===id);
  if (!l) return;
  let newL = JSON.parse(JSON.stringify(l));
  newL.id = (Date.now() + Math.random()).toString();
  newL.title += " (Copy)";
  listings.unshift(newL);
  renderTable();
}
window.cloneListing = cloneListing;

/* ========== FILTER / SEARCH / PAGINATION ========== */
document.getElementById('searchBar').oninput = function(e) {
  searchTerm = e.target.value;
  page = 1;
  renderTable();
};
document.getElementById('filterPlatform').onchange = function(e) {
  filterPlatform = e.target.value;
  page = 1;
  renderTable();
};
document.getElementById('perPage').onchange = function(e) {
  perPage = parseInt(e.target.value,10);
  page = 1;
  renderTable();
};
document.getElementById('hideSoldToggle').onchange = function(e) {
  hideSold = e.target.checked;
  page = 1;
  renderTable();
};
document.getElementById('prevPage').onclick = function() {
  if (page > 1) { page--; renderTable(); }
};
document.getElementById('nextPage').onclick = function() {
  let filtered = listings.filter(l => {
    if (hideSold && l.sold) return false;
    if (filterPlatform && !l.platforms[filterPlatform]) return false;
    if (searchTerm && !l.title.toLowerCase().includes(searchTerm.toLowerCase()) && !l.sku.toLowerCase().includes(searchTerm.toLowerCase())) return false;
    return true;
  });
  let totalPages = Math.ceil(filtered.length / perPage);
  if (page < totalPages) { page++; renderTable(); }
};

/* ========== USERNAME ========== */
document.getElementById('userName').textContent = userName;

/* ========== ANALYTICS CHARTS ========== */
function renderWorldChart() {
  const ctx = document.getElementById('worldChart').getContext('2d');
  if (window._worldChart) window._worldChart.destroy();
  window._worldChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Canada','USA','UK','France','Japan','Australia'],
      datasets: [{
        label: 'Units Sold',
        data: [22,12,7,6,3,2],
        backgroundColor: ['#06b6d4','#f87171','#fbbf24','#a3e635','#818cf8','#f472b6']
      }]
    },
    options: {
      plugins: { legend: {display: false}},
      scales: { y: {beginAtZero:true}}
    }
  });
}

/* ========== LEAFLET MAP ========== */
function renderCanadaMap() {
  if (window._canadaMap) { window._canadaMap.remove(); }
  let map = window._canadaMap = L.map('canadaMap').setView([56.1304, -106.3468], 3.5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'&copy; OpenStreetMap'
  }).addTo(map);
  // Dummy heatmap zones
  let sales = [
    {lat:43.7, lon:-79.42, value:8},    // Toronto
    {lat:45.42, lon:-75.69, value:5},   // Ottawa
    {lat:49.25, lon:-123.1, value:6},   // Vancouver
    {lat:51.05, lon:-114.07, value:4},  // Calgary
    {lat:53.54, lon:-113.49, value:3},  // Edmonton
    {lat:46.81, lon:-71.21, value:5},   // Quebec City
    {lat:45.50, lon:-73.57, value:7},   // Montreal
    {lat:44.65, lon:-63.57, value:2},   // Halifax
    {lat:49.9, lon:-97.13, value:2},    // Winnipeg
  ];
  sales.forEach(loc => {
    let color = loc.value >= 7 ? '#06b6d4' : loc.value >= 5 ? '#fbbf24' : '#f87171';
    let radius = loc.value*5000;
    L.circle([loc.lat, loc.lon], {
      color: color,
      fillColor: color,
      fillOpacity: 0.4,
      radius: radius
    }).addTo(map).bindTooltip(`${loc.value} buyers`);
  });
}

/* ========== INIT ========== */
window.onload = function() {
  renderTable();
  renderCanadaMap();
  renderWorldChart();
};
/* Responsive map redraw (Leaflet hack) */
window.addEventListener('resize', function() {
  if (window._canadaMap) setTimeout(()=>window._canadaMap.invalidateSize(), 100);
});
</script>
</body>
</html>

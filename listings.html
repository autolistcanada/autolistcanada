<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AutoList Canada — Listings</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Heroicons/Feather Icons -->
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    body {
      min-height: 100vh;
      background: url('listings-background.png') center/cover no-repeat fixed;
      position: relative;
    }
    .cream-overlay {
      background: rgba(253, 246, 240, 0.93);
      backdrop-filter: blur(0.5px);
      min-height: 100vh;
      min-width: 100vw;
      position: absolute;
      inset: 0;
      z-index: 0;
    }
    .sidebar-shadow {
      box-shadow: 2px 0 18px 0 rgba(0,0,0,0.09);
    }
    .dropdown-shadow {
      box-shadow: 0 2px 12px 0 rgba(0,0,0,0.07);
    }
    .tone-animate {
      transition: background 0.4s, color 0.4s;
      animation: tonePulse 3s infinite alternate;
    }
    @keyframes tonePulse {
      0% { box-shadow: 0 0 0 0 rgba(255,140,0,0.14);}
      100% { box-shadow: 0 0 12px 6px rgba(255,140,0,0.09);}
    }
    .leaflet-container {
      border-radius: 1.2rem;
      box-shadow: 0 2px 16px 0 rgba(0,0,0,0.07);
    }
    .ai-editor-modal-bg {
      background: rgba(0,0,0,0.26);
    }
  </style>
</head>
<body class="h-full w-full relative overflow-x-hidden">
  <div class="cream-overlay"></div>
  <!-- SIDEBAR -->
  <aside class="fixed top-0 left-0 h-full w-64 bg-white/95 sidebar-shadow z-30 flex flex-col items-center py-6">
    <img src="autolist-logo.png" class="w-16 h-16 rounded-full mb-2 shadow" alt="AutoList Logo">
    <img src="autolist-title.png" class="w-36 mb-8" alt="AutoList Title">
    <nav class="flex-1 w-full flex flex-col gap-2 px-4">
      <button class="sidebar-btn" data-nav="Home">Home</button>
      <button class="sidebar-btn" data-nav="Dashboard">Dashboard</button>
      <button class="sidebar-btn active" data-nav="Listings">Listings</button>
      <button class="sidebar-btn" data-nav="AI Tools">AI Tools</button>
      <button class="sidebar-btn" data-nav="How It Works">How It Works</button>
      <button class="sidebar-btn" data-nav="FAQ">FAQ</button>
      <button class="sidebar-btn" data-nav="Import">Import</button>
      <button class="sidebar-btn" data-nav="Terms">Terms</button>
      <button class="sidebar-btn" data-nav="Privacy">Privacy</button>
    </nav>
    <!-- Language Toggle -->
    <div class="mt-8 w-full flex flex-col items-center">
      <span class="mb-2 text-xs text-gray-500">Language</span>
      <div class="flex items-center gap-3 px-4">
        <span class="text-sm font-medium">EN</span>
        <label class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="lang-toggle" class="sr-only peer" autocomplete="off">
          <div class="w-11 h-6 bg-orange-200 peer-focus:outline-none rounded-full peer peer-checked:bg-rose-400 transition"></div>
          <span class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition peer-checked:translate-x-5"></span>
        </label>
        <span class="text-sm font-medium">FR</span>
      </div>
      <span class="mt-1 text-xs text-gray-400">🇨🇦</span>
    </div>
  </aside>
  <!-- MAIN CONTENT -->
  <main class="relative min-h-screen pl-64 z-10">
    <!-- HEADER/BANNER -->
    <div class="w-full py-6 bg-gradient-to-br from-orange-50 to-orange-100 flex items-center justify-center mb-2 shadow-sm">
      <img src="autolist-logo.png" alt="AutoList Canada" class="h-10 mr-4">
      <span class="text-2xl font-bold text-orange-700 tracking-wide">AutoList Canada — Listings Dashboard</span>
    </div>
    <!-- TOP CONNECTION PANEL -->
    <section class="flex items-center justify-between px-10 pt-8 pb-2">
      <div class="flex gap-4 w-full max-w-4xl">
        <!-- Platform Connection Cards -->
        <div id="connection-cards" class="flex gap-4">
          <!-- Cards will be injected by JS -->
        </div>
      </div>
      <!-- User session -->
      <div class="flex items-center gap-2">
        <span id="user-session" class="font-semibold text-gray-800"></span>
        <button id="sign-in-btn" class="hidden px-4 py-1 rounded bg-orange-500 text-white text-sm hover:bg-orange-600 shadow">Sign In</button>
      </div>
    </section>
    <!-- AI-ENHANCED LISTING EDITOR -->
    <section class="px-10 py-6 bg-white/80 rounded-xl shadow-lg mx-6 mt-8 mb-6 max-w-2xl">
      <h2 class="text-xl font-bold mb-4 text-orange-700 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Create/Edit Listing
      </h2>
      <form id="ai-listing-editor" class="space-y-4">
        <div>
          <label class="block text-sm font-semibold mb-1">Title</label>
          <div class="flex gap-2">
            <input id="editor-title" class="w-full border p-2 rounded" placeholder="Product title">
            <button type="button" id="editor-ai-title" class="bg-orange-500 text-white px-3 py-1 rounded hover:bg-orange-600 text-xs flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              AI Suggest
            </button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Description</label>
          <div class="flex gap-2">
            <textarea id="editor-desc" class="w-full border p-2 rounded" rows="3" placeholder="Product description"></textarea>
            <button type="button" id="editor-ai-desc" class="bg-orange-500 text-white px-3 py-1 rounded hover:bg-orange-600 text-xs flex items-center gap-1 self-start">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              AI Enhance
            </button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Price (CAD)</label>
          <input id="editor-price" type="number" min="0" step="0.01" class="border p-2 rounded w-32">
        </div>
        <div class="flex justify-end gap-2">
          <button type="submit" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">Preview</button>
        </div>
      </form>
      <div id="editor-preview" class="mt-4 hidden bg-orange-50 p-3 rounded border border-orange-100">
        <h3 class="font-semibold mb-1">Preview:</h3>
        <div id="editor-preview-content" class="text-sm text-gray-700"></div>
      </div>
    </section>
    <!-- SEARCH + FILTER BAR -->
    <section class="flex flex-wrap gap-4 items-center px-10 py-4 bg-white bg-opacity-70 rounded-xl mx-6 mb-3 shadow-sm dropdown-shadow">
      <input type="text" id="search-bar" placeholder="Search your listings..." class="flex-1 px-4 py-2 rounded-lg border border-gray-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-200 bg-[#fdf6f0]">
      <select id="platform-filter" class="px-3 py-2 bg-white rounded-lg border border-gray-200 shadow-sm focus:ring-orange-200">
        <option value="All">All Platforms</option>
        <option value="eBay">eBay</option>
        <option value="Poshmark">Poshmark</option>
        <option value="Facebook">Facebook</option>
        <option value="Etsy">Etsy</option>
        <option value="Depop">Depop</option>
        <option value="Shopify">Shopify</option>
        <option value="Mercari">Mercari</option>
        <option value="Instagram">Instagram</option>
        <option value="TikTok">TikTok</option>
      </select>
      <select id="intent-filter" class="px-3 py-2 bg-white rounded-lg border border-gray-200 shadow-sm focus:ring-orange-200">
        <option value="All">All Buyer Intents</option>
        <option value="Cozy">Cozy</option>
        <option value="Minimalist">Minimalist</option>
        <option value="Budget">Budget</option>
        <option value="Luxury">Luxury</option>
        <option value="Warm">Warm</option>
      </select>
      <label class="flex items-center gap-2 cursor-pointer">
        <input type="checkbox" id="hide-sold" class="accent-orange-500 scale-125">
        <span class="text-gray-600">Hide Sold</span>
      </label>
      <div class="flex gap-2 ml-auto">
        <button id="view-list" class="p-2 rounded-lg text-orange-500 bg-orange-100 border border-orange-200 shadow-sm" aria-label="List View">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="4" y="6" width="16" height="2" rx="1"/><rect x="4" y="11" width="16" height="2" rx="1"/><rect x="4" y="16" width="16" height="2" rx="1"/></svg>
        </button>
        <button id="view-grid" class="p-2 rounded-lg text-gray-500 hover:text-orange-500 bg-gray-100 border border-gray-200 shadow-sm" aria-label="Grid View">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="4" y="4" width="7" height="7" rx="2"/><rect x="13" y="4" width="7" height="7" rx="2"/><rect x="4" y="13" width="7" height="7" rx="2"/><rect x="13" y="13" width="7" height="7" rx="2"/></svg>
        </button>
      </div>
    </section>
    <!-- BULK ACTIONS BAR -->
    <section id="bulk-actions-bar" class="flex gap-3 items-center px-10 py-3 bg-orange-50 border-b border-orange-100 shadow-sm mx-6 rounded-t-xl hidden">
      <span class="font-semibold text-orange-700">Bulk Actions:</span>
      <button class="bulk-btn" data-action="sync">Bulk Sync</button>
      <button class="bulk-btn" data-action="editprice">Bulk Edit Price</button>
      <button class="bulk-btn" data-action="sold">Bulk Mark as Sold</button>
      <span class="ml-auto text-sm text-gray-600" id="bulk-count"></span>
      <button class="ml-4 px-2 py-1 rounded text-gray-500 hover:text-rose-500 font-bold" id="bulk-cancel">&times; Cancel</button>
    </section>
    <!-- LISTINGS (TABLE + GRID) -->
    <section id="listings-section" class="px-10 pb-1">
      <!-- TABLE VIEW -->
      <div id="listings-table-view" class="bg-white bg-opacity-80 rounded-xl shadow-md mt-3 overflow-x-auto">
        <table class="min-w-full divide-y divide-orange-100">
          <thead class="bg-orange-50">
            <tr>
              <th class="p-4"><input type="checkbox" id="select-all" class="accent-orange-500 scale-125"></th>
              <th class="p-4">Image</th>
              <th class="p-4">Title</th>
              <th class="p-4">Actions</th>
              <th class="p-4">SKU</th>
              <th class="p-4">Price</th>
              <th class="p-4">Platforms</th>
              <th class="p-4">Tone</th>
            </tr>
          </thead>
          <tbody id="listings-table-body" class="bg-white divide-y divide-orange-50">
            <!-- Rows injected by JS -->
          </tbody>
        </table>
      </div>
      <!-- GRID VIEW -->
      <div id="listings-grid-view" class="hidden mt-5 w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Cards injected by JS -->
      </div>
    </section>
    <!-- BUYER PSYCHOLOGY MAP -->
    <section class="px-10 mt-10">
      <h2 class="text-xl font-bold text-orange-700 mb-2">Buyer Psychology Map</h2>
      <div id="buyer-map" class="w-full h-80 rounded-xl overflow-hidden"></div>
      <div class="flex flex-wrap items-center gap-4 mt-3 font-medium text-sm">
        <span class="flex items-center gap-1"><span class="inline-block w-4 h-4 bg-blue-100 rounded-full"></span> Minimalist 🧊</span>
        <span class="flex items-center gap-1"><span class="inline-block w-4 h-4 bg-yellow-100 rounded-full"></span> Warm ☀️</span>
        <span class="flex items-center gap-1"><span class="inline-block w-4 h-4 bg-orange-100 rounded-full"></span> Cozy 🧸</span>
        <span class="flex items-center gap-1"><span class="inline-block w-4 h-4 bg-rose-100 rounded-full"></span> Luxury 💎</span>
        <span class="flex items-center gap-1"><span class="inline-block w-4 h-4 bg-green-100 rounded-full"></span> Budget 🌱</span>
      </div>
    </section>
    <!-- FOOTER -->
    <footer class="flex flex-col md:flex-row md:justify-between items-center gap-4 px-10 py-7 mt-12 mb-2 bg-white bg-opacity-80 rounded-xl shadow-sm mx-6">
      <div class="flex gap-4">
        <img src="canadian-owned-badge.png" class="h-12" alt="Canadian Owned">
        <img src="ai-powered-tools-badge.png" class="h-12" alt="AI Powered">
        <img src="privacy-first-badge.png" class="h-12" alt="Privacy First">
      </div>
      <div class="text-gray-700 text-center font-medium text-sm">
        AutoList Canada © 2025 — Built with trust, science, and Canadian soul 🇨🇦
      </div>
    </footer>
  </main>
  <!-- MODALS -->
  <!-- AI Suggest Modal -->
  <div id="ai-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center ai-editor-modal-bg">
    <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-8 relative">
      <button class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-rose-500" onclick="closeAIModal()">&times;</button>
      <h3 class="text-lg font-bold mb-2 text-orange-600">AI-Suggested Listing</h3>
      <div id="ai-suggest-body" class="mb-4 text-gray-800 text-base whitespace-pre-line"></div>
      <div class="flex justify-end gap-2">
        <button class="px-4 py-1.5 rounded bg-gray-100 hover:bg-gray-200 text-gray-700" onclick="closeAIModal()">Close</button>
        <button class="px-4 py-1.5 rounded bg-orange-500 text-white hover:bg-orange-600" onclick="applyAISuggestion()">Apply</button>
      </div>
    </div>
  </div>
  <!-- Comment Modal -->
  <div id="comment-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 relative">
      <button class="absolute top-3 right-4 text-2xl text-gray-400 hover:text-rose-500" onclick="closeCommentModal()">&times;</button>
      <h3 class="text-lg font-bold text-orange-600 mb-2">Listing Comments</h3>
      <textarea id="comment-text" rows="5" class="w-full border border-orange-200 rounded-lg px-3 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-orange-200"></textarea>
      <div class="flex justify-end gap-2">
        <button class="px-4 py-1.5 rounded bg-gray-100 hover:bg-gray-200 text-gray-700" onclick="closeCommentModal()">Cancel</button>
        <button class="px-4 py-1.5 rounded bg-orange-500 text-white hover:bg-orange-600" onclick="saveComment()">Save</button>
      </div>
    </div>
  </div>
  <script>
    // ------------- GLOBAL STATE -----------
    // Simulated data for platforms and listings
    const platforms = [
      {name: 'eBay', color: 'bg-[#1e59b0]', icon: 'https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/ebay.svg', connected: true},
      {name: 'Poshmark', color: 'bg-[#d3215a]', icon: 'https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/poshmark.svg', connected: true},
      {name: 'Facebook', color: 'bg-[#1778f2]', icon: 'https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/facebook.svg', connected: true},
      {name: 'Etsy', color: 'bg-[#f1641e]', icon: 'https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/etsy.svg', connected: false},
      {name: 'Depop', color: 'bg-[#ff2200]', icon: 'https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/depop.svg', connected: false},
      {name: 'Shopify', color: 'bg-[#96bf48]', icon: 'https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/shopify.svg', connected: false},
      {name: 'Mercari', color: 'bg-[#2274a5]', icon: 'https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/mercari.svg', connected: false},
      {name: 'Instagram', color: 'bg-gradient-to-tr from-pink-400 via-red-400 to-yellow-400', icon: 'https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/instagram.svg', connected: false},
      {name: 'TikTok', color: 'bg-[#010101]', icon: 'https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/tiktok.svg', connected: false},
    ];
    const tones = [
      {name: 'Cozy', color: 'bg-orange-100 text-orange-800', emoji: '🧸'},
      {name: 'Minimalist', color: 'bg-blue-100 text-blue-800', emoji: '🧊'},
      {name: 'Budget', color: 'bg-green-100 text-green-800', emoji: '🌱'},
      {name: 'Luxury', color: 'bg-rose-100 text-rose-800', emoji: '💎'},
      {name: 'Warm', color: 'bg-yellow-100 text-yellow-800', emoji: '☀️'},
    ];
    let userSession = { email: "seller@canada.ca", signedIn: true };

    // Simulated Listings Data
    let listings = [
      {
        id: 1,
        image: 'https://images.unsplash.com/photo-1512436991641-6745cdb1723f?auto=format&fit=crop&w=300&q=80',
        title: 'Cozy Hand-knit Scarf',
        sku: 'SCF-001',
        price: 34.99,
        platforms: {eBay: true, Poshmark: true, Facebook: false, Etsy: false, Depop: false, Shopify: false, Mercari: false, Instagram: false, TikTok: false},
        tone: 'Cozy',
        sold: false,
        comment: 'Great winter seller!',
        visible: true,
      },
      {
        id: 2,
        image: 'https://images.unsplash.com/photo-1519125323398-675f0ddb6308?auto=format&fit=crop&w=300&q=80',
        title: 'Minimalist Ceramic Vase',
        sku: 'VAS-101',
        price: 58.00,
        platforms: {eBay: true, Poshmark: false, Facebook: true, Etsy: true, Depop: false, Shopify: false, Mercari: false, Instagram: false, TikTok: false},
        tone: 'Minimalist',
        sold: false,
        comment: '',
        visible: true,
      },
      {
        id: 3,
        image: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=300&q=80',
        title: 'Luxury Cashmere Throw',
        sku: 'THR-202',
        price: 199.99,
        platforms: {eBay: true, Poshmark: true, Facebook: true, Etsy: false, Depop: false, Shopify: false, Mercari: false, Instagram: true, TikTok: false},
        tone: 'Luxury',
        sold: false,
        comment: '',
        visible: true,
      },
      {
        id: 4,
        image: 'https://images.unsplash.com/photo-1526178613658-3f1622045557?auto=format&fit=crop&w=300&q=80',
        title: 'Budget Kitchen Utensil Set',
        sku: 'KIT-303',
        price: 14.50,
        platforms: {eBay: false, Poshmark: false, Facebook: true, Etsy: false, Depop: false, Shopify: false, Mercari: true, Instagram: false, TikTok: false},
        tone: 'Budget',
        sold: true,
        comment: '',
        visible: true,
      },
      {
        id: 5,
        image: 'https://images.unsplash.com/photo-1526171111615-368b1d4bcebb?auto=format&fit=crop&w=300&q=80',
        title: 'Warm Woollen Hat',
        sku: 'HAT-404',
        price: 28.00,
        platforms: {eBay: true, Poshmark: false, Facebook: true, Etsy: false, Depop: true, Shopify: false, Mercari: false, Instagram: false, TikTok: false},
        tone: 'Warm',
        sold: false,
        comment: 'Popular last fall.',
        visible: true,
      }
    ];

    // For bulk actions
    let selectedListings = new Set();

    // ------------- SIDEBAR LOGIC -----------
    // Sidebar styling
    function updateSidebarActive() {
      document.querySelectorAll('.sidebar-btn').forEach(btn => {
        if (btn.dataset.nav === "Listings") {
          btn.classList.add('bg-orange-500', 'text-white', 'shadow-md');
        } else {
          btn.classList.remove('bg-orange-500', 'text-white', 'shadow-md');
        }
      });
    }
    // Initial sidebar button styles
    document.querySelectorAll('.sidebar-btn').forEach(btn => {
      btn.classList.add(
        'w-full', 'text-left', 'px-4', 'py-2.5', 'mb-1', 'rounded-lg',
        'bg-white', 'text-gray-700', 'hover:bg-orange-100',
        'transition', 'shadow-sm', 'font-semibold', 'text-base', 'relative'
      );
      if (btn.dataset.nav === "Listings") btn.classList.add('bg-orange-500','text-white','shadow-md');
      btn.addEventListener('click', () => {
        // Simulate navigation
        alert('Navigation to "'+btn.dataset.nav+'" simulated.');
      });
    });

    // Language toggle
    document.getElementById('lang-toggle').addEventListener('change', function() {
      let lang = this.checked ? 'FR' : 'EN';
      // Simulate language change (just alert for demo)
      alert('Language switched to '+lang+' (simulation)');
    });

    // ------------- CONNECTION PANEL LOGIC -----------
    function renderConnectionCards() {
      const wrap = document.getElementById('connection-cards');
      wrap.innerHTML = '';
      platforms.forEach((plat, i) => {
        const connected = plat.connected;
        wrap.innerHTML += `
        <div class="flex items-center gap-2 bg-white border ${connected ? 'border-orange-200' : 'border-gray-200 opacity-60'} shadow-sm px-3 py-2 rounded-lg min-w-[110px] transition relative group">
          <span class="w-7 h-7 rounded-full flex items-center justify-center ${plat.color} shadow-lg ${connected ? '' : 'grayscale'}">
            <img src="${plat.icon}" class="w-5 h-5 object-contain" alt="${plat.name}">
          </span>
          <span class="font-semibold text-sm ${connected ? 'text-gray-700' : 'text-gray-400'}">${plat.name}</span>
          ${connected ? `
            <span class="ml-1 text-[11px] px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-semibold">Connected</span>
          ` : `
            <button onclick="connectPlatform('${plat.name}')" class="ml-2 px-2 py-0.5 rounded bg-orange-500 text-white text-xs font-bold hover:bg-orange-600 shadow">Connect</button>
          `}
        </div>
        `;
      });
    }
    function connectPlatform(name) {
      setTimeout(() => {
        platforms.find(p=>p.name===name).connected = true;
        renderConnectionCards();
        alert(`Simulated ${name} connection successful!`);
        renderListingsTable();
        renderListingsGrid();
      }, 650);
    }
    renderConnectionCards();

    // Session logic
    function updateUserSession() {
      const emailEl = document.getElementById('user-session');
      const signInBtn = document.getElementById('sign-in-btn');
      if (userSession.signedIn) {
        emailEl.textContent = userSession.email;
        signInBtn.classList.add('hidden');
      } else {
        emailEl.textContent = '';
        signInBtn.classList.remove('hidden');
      }
    }
    document.getElementById('sign-in-btn').onclick = () => {
      userSession = {email:"seller@canada.ca", signedIn: true};
      updateUserSession();
    }
    updateUserSession();

    // ------------- AI LISTING EDITOR: AI Buttons + Preview -----------
    // AI Title suggestion logic
    function aiSuggestTitle(text) {
      if (!text) return "Amazing Canadian Find!";
      return "Gently Used - " + text.split(' ').slice(0, 5).join(' ') + "...";
    }
    // AI Enhance description logic
    function aiEnhanceDesc(desc) {
      return desc + " 🚀 Ships from Canada. Fast, reliable, and authentic! 🇨🇦";
    }
    document.getElementById('editor-ai-title').onclick = function() {
      document.getElementById('editor-title').value = aiSuggestTitle(document.getElementById('editor-desc').value);
    }
    document.getElementById('editor-ai-desc').onclick = function() {
      document.getElementById('editor-desc').value = aiEnhanceDesc(document.getElementById('editor-desc').value);
    }
    document.getElementById('ai-listing-editor').onsubmit = function(e) {
      e.preventDefault();
      const title = document.getElementById('editor-title').value;
      const desc = document.getElementById('editor-desc').value;
      const price = document.getElementById('editor-price').value;
      document.getElementById('editor-preview-content').innerHTML = `
        <div><strong>Title:</strong> ${title}</div>
        <div><strong>Description:</strong> ${desc}</div>
        <div><strong>Price:</strong> $${parseFloat(price).toFixed(2)} CAD</div>
      `;
      document.getElementById('editor-preview').classList.remove('hidden');
    };

    // ------------- SEARCH & FILTER LOGIC -----------
    function filterListings() {
      let search = document.getElementById('search-bar').value.trim().toLowerCase();
      let plat = document.getElementById('platform-filter').value;
      let intent = document.getElementById('intent-filter').value;
      let hideSold = document.getElementById('hide-sold').checked;
      let filtered = listings.filter(list => {
        if (search && !list.title.toLowerCase().includes(search) && !list.sku.toLowerCase().includes(search)) return false;
        if (plat !== 'All' && !list.platforms[plat]) return false;
        if (intent !== 'All' && list.tone !== intent) return false;
        if (hideSold && list.sold) return false;
        return true;
      });
      return filtered;
    }
    ['search-bar','platform-filter','intent-filter','hide-sold'].forEach(id=>{
      document.getElementById(id).addEventListener('input', ()=>{ renderListingsTable(); renderListingsGrid(); });
      document.getElementById(id).addEventListener('change', ()=>{ renderListingsTable(); renderListingsGrid(); });
    });

    // ------------- VIEW TOGGLE -----------
    let viewMode = 'list';
    document.getElementById('view-list').addEventListener('click', () => {
      viewMode = 'list';
      setView();
    });
    document.getElementById('view-grid').addEventListener('click', () => {
      viewMode = 'grid';
      setView();
    });
    function setView() {
      if (viewMode === 'list') {
        document.getElementById('listings-table-view').classList.remove('hidden');
        document.getElementById('listings-grid-view').classList.add('hidden');
        document.getElementById('view-list').classList.add('text-orange-500','bg-orange-100','border-orange-200');
        document.getElementById('view-list').classList.remove('text-gray-500','bg-gray-100','border-gray-200');
        document.getElementById('view-grid').classList.remove('text-orange-500','bg-orange-100','border-orange-200');
        document.getElementById('view-grid').classList.add('text-gray-500','bg-gray-100','border-gray-200');
      } else {
        document.getElementById('listings-table-view').classList.add('hidden');
        document.getElementById('listings-grid-view').classList.remove('hidden');
        document.getElementById('view-grid').classList.add('text-orange-500','bg-orange-100','border-orange-200');
        document.getElementById('view-grid').classList.remove('text-gray-500','bg-gray-100','border-gray-200');
        document.getElementById('view-list').classList.remove('text-orange-500','bg-orange-100','border-orange-200');
        document.getElementById('view-list').classList.add('text-gray-500','bg-gray-100','border-gray-200');
      }
    }
    setView();

    // ------------- LISTINGS TABLE LOGIC -----------
    function renderListingsTable() {
      let filtered = filterListings();
      let tbody = document.getElementById('listings-table-body');
      tbody.innerHTML = '';
      filtered.forEach(list => {
        let isChecked = selectedListings.has(list.id) ? 'checked' : '';
        let platformIcons = platforms.map(plat => `
          <label class="inline-flex items-center mr-1">
            <input type="checkbox" class="accent-orange-500" ${list.platforms[plat.name] ? 'checked' : ''} data-listing="${list.id}" data-platform="${plat.name}" onchange="togglePlatformSync(${list.id},'${plat.name}')">
            <img src="${plat.icon}" class="inline w-5 h-5 ml-1 ${list.platforms[plat.name] && plat.connected ? '' : 'grayscale opacity-40'}" alt="${plat.name}">
          </label>
        `).join('');
        let toneObj = tones.find(t=>t.name===list.tone)||{color:'bg-gray-100',emoji:'❓'};
        tbody.innerHTML += `
          <tr class="${list.sold ? 'opacity-60 bg-gray-100' : ''}" id="listing-row-${list.id}">
            <td class="p-4"><input type="checkbox" class="select-row accent-orange-500 scale-125" value="${list.id}" ${isChecked}></td>
            <td class="p-4">
              <img src="${list.image}" class="w-14 h-14 rounded-lg object-cover shadow" alt="${list.title}">
            </td>
            <td class="p-4 font-semibold text-gray-900" id="title-cell-${list.id}">
              <span>${list.title}</span>
            </td>
            <td class="p-4">
              <button class="p-1 rounded hover:bg-orange-50" title="Edit" onclick="editListing(${list.id})"><i data-feather="edit" class="w-5 h-5 text-orange-500"></i></button>
              <button class="p-1 rounded hover:bg-orange-50" title="Delete" onclick="deleteListing(${list.id})"><i data-feather="trash-2" class="w-5 h-5 text-rose-400"></i></button>
              <button class="p-1 rounded hover:bg-orange-50" title="AI Suggest" onclick="showAIModal(${list.id})"><i data-feather="zap" class="w-5 h-5 text-yellow-500"></i></button>
              <button class="p-1 rounded hover:bg-orange-50" title="Comment" onclick="showCommentModal(${list.id})"><i data-feather="message-circle" class="w-5 h-5 text-blue-400"></i></button>
            </td>
            <td class="p-4">${list.sku}</td>
            <td class="p-4 price-edit" id="price-cell-${list.id}">
              <span>$${list.price.toFixed(2)}</span>
            </td>
            <td class="p-4">${platformIcons}</td>
            <td class="p-4">
              <span class="inline-flex items-center px-3 py-1 rounded-full font-semibold tone-animate ${toneObj.color}">
                <span class="mr-1">${toneObj.emoji}</span> ${list.tone}
              </span>
            </td>
          </tr>
        `;
      });
      feather.replace();
      // Add event listeners for row selection
      document.querySelectorAll('.select-row').forEach(cb => {
        cb.onchange = function() {
          let id = parseInt(this.value);
          if (this.checked) {
            selectedListings.add(id);
          } else {
            selectedListings.delete(id);
          }
          updateBulkBar();
        }
      });
      // Select all checkbox
      document.getElementById('select-all').checked = (filtered.length > 0 && filtered.every(l=>selectedListings.has(l.id)));
      updateBulkBar();
    }
    // Inline edit
    function editListing(id) {
      let row = document.getElementById('listing-row-' + id);
      let listing = listings.find(l=>l.id===id);
      // Title
      let titleCell = document.getElementById('title-cell-' + id);
      titleCell.innerHTML = `<input id="edit-title-${id}" value="${listing.title}" class="px-2 py-1 border rounded bg-white w-44 text-gray-800 font-medium">`;
      // Price
      let priceCell = document.getElementById('price-cell-' + id);
      priceCell.innerHTML = `<input id="edit-price-${id}" type="number" step="0.01" value="${listing.price}" class="px-2 py-1 border rounded bg-white w-20 text-gray-800 font-medium">`;
      // Save on blur or Enter
      document.getElementById('edit-title-' + id).addEventListener('blur', function() {
        listing.title = this.value;
        renderListingsTable();
        renderListingsGrid();
      });
      document.getElementById('edit-price-' + id).addEventListener('blur', function() {
        listing.price = parseFloat(this.value) || listing.price;
        renderListingsTable();
        renderListingsGrid();
      });
      document.getElementById('edit-title-' + id).addEventListener('keydown', function(e){
        if(e.key==='Enter'){ this.blur();}
      });
      document.getElementById('edit-price-' + id).addEventListener('keydown', function(e){
        if(e.key==='Enter'){ this.blur();}
      });
      document.getElementById('edit-title-' + id).focus();
    }
    // Platform sync toggle
    function togglePlatformSync(listingId, platformName) {
      let listing = listings.find(l=>l.id===listingId);
      if (platforms.find(p=>p.name===platformName).connected)
        listing.platforms[platformName] = !listing.platforms[platformName];
      else {
        alert(`${platformName} is not connected. Please connect first.`);
      }
      renderListingsTable();
      renderListingsGrid();
    }
    // Delete
    function deleteListing(id) {
      if (confirm('Delete this listing?')) {
        listings = listings.filter(l => l.id !== id);
        selectedListings.delete(id);
        renderListingsTable();
        renderListingsGrid();
      }
    }
    // Select all
    document.getElementById('select-all').onchange = function() {
      let filtered = filterListings();
      if (this.checked) {
        filtered.forEach(l=>selectedListings.add(l.id));
      } else {
        filtered.forEach(l=>selectedListings.delete(l.id));
      }
      renderListingsTable();
      updateBulkBar();
    };

    // ------------- BULK ACTIONS LOGIC -----------
    function updateBulkBar() {
      let bar = document.getElementById('bulk-actions-bar');
      let count = Array.from(selectedListings).filter(id=>listings.some(l=>l.id===id && !l.sold)).length;
      if (count > 0) {
        bar.classList.remove('hidden');
        document.getElementById('bulk-count').textContent = `${count} selected`;
      } else {
        bar.classList.add('hidden');
      }
    }
    document.querySelectorAll('.bulk-btn').forEach(btn=>{
      btn.onclick = function() {
        let action = this.dataset.action;
        let ids = Array.from(selectedListings);
        if (action === 'sync') {
          ids.forEach(id=>{
            let l = listings.find(x=>x.id===id);
            Object.keys(l.platforms).forEach(p=>{
              if (platforms.find(plat=>plat.name===p).connected) l.platforms[p]=true;
            });
          });
          alert('Listings have been synced to all connected platforms (simulated).');
        } else if (action === 'editprice') {
          let newPrice = prompt('Bulk price update: Enter new price for selected listings:');
          if (newPrice) {
            ids.forEach(id=>{
              let l = listings.find(x=>x.id===id);
              l.price = parseFloat(newPrice);
            });
          }
        } else if (action === 'sold') {
          ids.forEach(id=>{
            let l = listings.find(x=>x.id===id);
            l.sold = true;
          });
        }
        selectedListings.clear();
        renderListingsTable();
        renderListingsGrid();
      }
    });
    document.getElementById('bulk-cancel').onclick=function(){
      selectedListings.clear();
      renderListingsTable();
      renderListingsGrid();
    };

    // ------------- GRID VIEW LOGIC -----------
    function renderListingsGrid() {
      let filtered = filterListings();
      let grid = document.getElementById('listings-grid-view');
      grid.innerHTML = '';
      filtered.forEach(list=>{
        let toneObj = tones.find(t=>t.name===list.tone)||{color:'bg-gray-100',emoji:'❓'};
        let platformIcons = platforms.map(plat=>`
          <img src="${plat.icon}" class="inline w-5 h-5 mr-1 ${list.platforms[plat.name] && plat.connected ? '' : 'grayscale opacity-40'}" alt="${plat.name}">
        `).join('');
        grid.innerHTML += `
          <div class="bg-white rounded-xl shadow-md relative flex flex-col p-4 group ${list.sold ? 'opacity-60 bg-gray-100' : ''}">
            <img src="${list.image}" class="rounded-lg object-cover w-full h-40 mb-2 shadow" alt="${list.title}">
            <div class="flex justify-between items-center mb-2">
              <span class="font-bold text-base text-gray-800">${list.title}</span>
              <span class="font-semibold text-orange-600 text-lg">$${list.price.toFixed(2)}</span>
            </div>
            <div class="flex flex-wrap items-center gap-2 mb-2">${platformIcons}</div>
            <span class="inline-flex items-center px-3 py-1 rounded-full font-semibold text-sm mb-2 tone-animate ${toneObj.color}">
              <span class="mr-1">${toneObj.emoji}</span> ${list.tone}
            </span>
            <div class="flex items-center gap-3 mt-auto">
              <button class="p-1 rounded hover:bg-orange-50" title="Edit" onclick="editListingGrid(${list.id}, this)"><i data-feather="edit" class="w-5 h-5 text-orange-500"></i></button>
              <button class="p-1 rounded hover:bg-orange-50" title="AI Suggest" onclick="showAIModal(${list.id})"><i data-feather="zap" class="w-5 h-5 text-yellow-500"></i></button>
              <button class="p-1 rounded hover:bg-orange-50" title="Comment" onclick="showCommentModal(${list.id})"><i data-feather="message-circle" class="w-5 h-5 text-blue-400"></i></button>
              <label class="ml-auto flex items-center gap-1 text-xs font-medium">
                <input type="checkbox" ${list.visible ? 'checked' : ''} onchange="toggleVisibility(${list.id})" class="accent-orange-500">
                <span>${list.visible ? 'Visible' : 'Hidden'}</span>
              </label>
            </div>
          </div>
        `;
      });
      feather.replace();
    }
    function editListingGrid(id, btn) {
      let listing = listings.find(l=>l.id===id);
      let card = btn.closest('.flex.flex-col');
      card.querySelector('.font-bold').innerHTML = `<input id="edit-title-g${id}" value="${listing.title}" class="px-2 py-1 border rounded bg-white w-36 text-gray-800 font-medium">`;
      card.querySelector('.font-semibold.text-orange-600').innerHTML = `<input id="edit-price-g${id}" type="number" step="0.01" value="${listing.price}" class="px-2 py-1 border rounded bg-white w-16 text-gray-800 font-medium">`;
      document.getElementById('edit-title-g'+id).addEventListener('blur', function() {
        listing.title = this.value;
        renderListingsGrid();
        renderListingsTable();
      });
      document.getElementById('edit-price-g'+id).addEventListener('blur', function() {
        listing.price = parseFloat(this.value)||listing.price;
        renderListingsGrid();
        renderListingsTable();
      });
      document.getElementById('edit-title-g'+id).addEventListener('keydown', function(e){
        if(e.key==='Enter'){ this.blur();}
      });
      document.getElementById('edit-price-g'+id).addEventListener('keydown', function(e){
        if(e.key==='Enter'){ this.blur();}
      });
      document.getElementById('edit-title-g'+id).focus();
    }
    function toggleVisibility(id) {
      let listing = listings.find(l=>l.id===id);
      listing.visible = !listing.visible;
      renderListingsGrid();
      renderListingsTable();
    }

    // ------------- AI SUGGEST MODAL LOGIC -----------
    let aiModalListingId = null;
    function showAIModal(id) {
      aiModalListingId = id;
      const listing = listings.find(l=>l.id===id);
      const suggestion = `Title: ${listing.title}
Description: 
${listing.tone === 'Cozy' ? 'Snuggle up with this hand-knit scarf, perfect for chilly Canadian winters. Soft, stylish, and sure to sell fast.' : ''}
${listing.tone === 'Minimalist' ? 'Clean lines, timeless design. This ceramic vase brings calm and clarity to any space.' : ''}
${listing.tone === 'Luxury' ? 'Indulge in the rich softness of cashmere. This throw transforms any room into a sanctuary of comfort.' : ''}
${listing.tone === 'Budget' ? 'Essential kitchen tools at a price that makes sense. Upgrade your kitchen without breaking the bank.' : ''}
${listing.tone === 'Warm' ? 'Classic beanie for cozy warmth. A staple for braving Canadian breezes.' : ''}
Price: $${listing.price.toFixed(2)}
Platforms: ${Object.keys(listing.platforms).filter(p=>listing.platforms[p]).join(', ')}
Tone: ${listing.tone}`;
      document.getElementById('ai-suggest-body').textContent = suggestion;
      document.getElementById('ai-modal').classList.remove('hidden');
    }
    function closeAIModal() {
      document.getElementById('ai-modal').classList.add('hidden');
      aiModalListingId = null;
    }
    function applyAISuggestion() {
      if (aiModalListingId !== null) {
        alert('AI suggestion applied to listing (simulation)');
        closeAIModal();
      }
    }

    // ------------- COMMENTS MODAL LOGIC -----------
    let commentModalListingId = null;
    function showCommentModal(id) {
      commentModalListingId = id;
      const listing = listings.find(l=>l.id===id);
      document.getElementById('comment-text').value = listing.comment || '';
      document.getElementById('comment-modal').classList.remove('hidden');
    }
    function closeCommentModal() {
      document.getElementById('comment-modal').classList.add('hidden');
      commentModalListingId = null;
    }
    function saveComment() {
      if (commentModalListingId !== null) {
        const val = document.getElementById('comment-text').value;
        listings.find(l=>l.id===commentModalListingId).comment = val;
        closeCommentModal();
      }
    }

    // ------------- INITIAL RENDER -----------
    renderListingsTable();
    renderListingsGrid();

    // ------------- BUYER PSYCHOLOGY MAP (LEAFLET) -----------
    // Bubble regions: BC, Quebec, Prairies, Toronto, Maritimes
    const regionData = [
      { name: "BC", lat: 53.7267, lng: -127.6476, tone: "Minimalist", emoji: "🧊", color: "#bfdbfe", buyerCount: 120 },
      { name: "Quebec", lat: 52.9399, lng: -71.4548, tone: "Warm", emoji: "☀️", color: "#fde68a", buyerCount: 80 },
      { name: "Prairies", lat: 53.9333, lng: -106.4509, tone: "Cozy", emoji: "🧸", color: "#fed7aa", buyerCount: 60 },
      { name: "Toronto", lat: 43.6532, lng: -79.3832, tone: "Luxury", emoji: "💎", color: "#fecdd3", buyerCount: 90 },
      { name: "Maritimes", lat: 46.5653, lng: -66.4619, tone: "Budget", emoji: "🌱", color: "#bbf7d0", buyerCount: 55 },
    ];
    setTimeout(()=>{
      const map = L.map('buyer-map', {
        zoomControl: false,
        dragging: false,
        tap: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        keyboard: false,
        attributionControl: false
      }).setView([54, -97], 3.2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        minZoom: 3,
        maxZoom: 6,
        opacity: 0.6
      }).addTo(map);
      regionData.forEach(region => {
        let radius = 18 + region.buyerCount * 0.6;
        let marker = L.circleMarker([region.lat, region.lng], {
          radius: radius,
          fillColor: region.color,
          color: "#fff",
          weight: 2,
          fillOpacity: 0.9,
          className: "buyer-bubble"
        }).addTo(map);
        marker.bindTooltip(`<div style="font-size:17px;font-weight:bold;">${region.emoji} ${region.tone}</div>
          <div style="font-size:14px;">${region.name}<br>Buyers: <b>${region.buyerCount}</b></div>`, {direction:'top', offset:[0,-10]});
        marker.on('mouseover', function() { marker.openTooltip(); });
        marker.on('mouseout', function() { marker.closeTooltip(); });
      });
    }, 200);

    // ------------- UTILS -----------
    window.showAIModal = showAIModal;
    window.closeAIModal = closeAIModal;
    window.applyAISuggestion = applyAISuggestion;
    window.showCommentModal = showCommentModal;
    window.closeCommentModal = closeCommentModal;
    window.saveComment = saveComment;
    window.togglePlatformSync = togglePlatformSync;
    window.deleteListing = deleteListing;
    window.editListing = editListing;
    window.editListingGrid = editListingGrid;
    window.toggleVisibility = toggleVisibility;

  </script>
</body>
</html>
